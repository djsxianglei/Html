/*
	author:wanghaixin@jd.com
	date:20130320
	ver:v1.0.0
	
	description:
	
*/


/*
 *  extending of original object
 */



/*
each is similar to Array object's foreach API in JS 1.6. 
@param : handler which acts on the elements in the array
return : no
*/
Array.prototype.each = function(fun){
	if(!fun.constructor == Function) return;
		for(var i = 0, len = this.length;i <len; i++) fun.call(this,i,this[i]);
}; 

Array.prototype.isIn = function(arg){
	for(var i = this.length; i > 0; i--){
		if(this[i-1] == arg)
			return true;
	}
	return false;
};

/*
 * 或者在数组中的位置
 */
Array.prototype.getIndex = function(arg){
	for(var i = 0, len = this.length; i < len; i++){
		if(this[i] == arg)
			return i;
	}
	return -1;
};

/*
 * 数组过滤，过滤在另一数组中存在的数据
 */
Array.prototype.aUnique = function(arr){
	if(arr.constructor != Array)
		throw new Error('Array.aUnique:arguments error!');
	var _result = [];
	for(var i = 0, len = arr.length; i < len; i++){
		if(!this.isIn(arr[i]))
			_result.push(arr[i]);
	}
	return _result;
};

/*
 * 去除数组中某个元素
 */
Array.prototype.del= function(ele){
	  var index = this.getIndex(ele);
      if(index != -1){
            this.splice(index,1);
      }
      return this;	
};

/** 获取全局参数中配置的静态资源路径 20151202 cdwanchuan@jd.com */
var RESOURCEPATH = jQuery('#resourcePath').val();

/** 二级域名列表 20151202 cdwanchuan@jd.com */
var SLD = {
	followSoa : '//follow-soa.jd.com', //关注
	p : '//p.3.cn', //京东价
	pm : '//pm.3.cn',//手机价
	jprice : '//jprice.jd.com',//ept
	ipi360buy : '//ipi.360buy.jd.com',//newEpt
	vsp : '//vsp.jd.com',//大客户
	ipr360buy : '//ipr.360buy.jd.com',//新EPT获取商品折扣及促销广告词
	ad : '//ad.3.cn', //商品促销标签
	cart : '//cart.jd.com', //购物车
	creadE : '//cread.e.jd.com', //电子书
	activity : '//activity.jd.com',  //投票
	soaYushou : '//soa.yushou.jd.com', //预售老接口
	yushou : '//yushou.jd.com', //预售新接口
	diviner : '//diviner.jd.com', //商品智能推荐接口 //商品浏览历史记录
	rankM : '//rank.m.jd.com', //调用二级分类类目的地址及商品列表地址（热门排行榜） 20151202星期三还未支持https
	lsActivity : '//ls.activity.jd.com', //中奖信息
	l : '//l.activity.jd.com',//抽奖及次数
	paimai : '//paimai.jd.com', //拍卖
	group : '//group.jd.com', //圈子
	passport : '//passport.jd.com', // 登录
	chat1 : '//chat1.jd.com', //店铺客服
	jimi : '//jimi.jd.com', //JIMI
	gate : '//gate.jd.com', //添加到购物车地址
	item : '//item.jd.com', //商品详情页
	actJshop : '//act.jshop.jd.com' //JSHOP提供的act接口
};

/** 浏览器协议 20151202 cdwanchuan@jd.com */
var getHttp = function(){
	return 'https:' == document.location.protocol ? 'https://' : 'http://'; 
}

/** 接口 20151010 cdwanchuan@jd.com */
var INTERFACE = {
	activityFollw :{
		follow : SLD.followSoa + '/rpc/activity/follow', //关注活动
		unfollow : SLD.followSoa + '/rpc/activity/unfollow', //取消关注活动
		isFollow : SLD.followSoa + '/rpc/activity/isFollow', //查询用户是否关注某活动
		queryForPage : SLD.followSoa + '/rpc/activity/queryForPage', //查询用户关注活动列表
		queryForCount : SLD.followSoa + '/rpc/activity/queryForCount', //查询用户关注活动数量
		isFollowBrand : SLD.followSoa + '/rpc/activity/isFollowBrand' //查询活动是否被关注 （20151009吴劲平 根据代码遗留情况看，有一部分活动变成了现在的品牌，应该是遗留问题 ）
	},
	venderFollow : {
		follow : SLD.followSoa + '/rpc/vender/follow', //关注店铺
		queryForCount : SLD.followSoa + '/rpc/vender/queryForCount', //查询用户关注店铺数量
		queryTagForListByCount : SLD.followSoa + '/rpc/vender/queryTagForListByCount', //新接口已经移除
		editTag : SLD.followSoa + '/rpc/vender/editTag', //新接口已经移除
		queryForPage  : SLD.followSoa + '/rpc/vender/queryForPage' //查询用户关注店铺列表
	},
	brandFollow : {
		follow : SLD.followSoa + '/rpc/brand/follow', //单个品牌关注
		unfollow : SLD.followSoa + '/rpc/brand/unfollow', //单个取消关注品牌
		queryForCountByPin : SLD.followSoa + '/rpc/brand/queryForCountByPin', //查询用户关注品牌数量
		batchfollow : SLD.followSoa + '/rpc/brand/batchfollow', //批量品牌关注
		batchIsFollow : SLD.followSoa + '/rpc/brand/batchIsFollow', //批量查询是否已关注品牌
		batchUnfollow : SLD.followSoa + '/rpc/brand/batchUnfollow' //批量取消关注品牌
	},
	productFollow : {
		follow : SLD.followSoa + '/rpc/product/follow', //关注商品
		queryForCountByPid : SLD.followSoa + '/rpc/product/queryForCountByPid', //商品关注人数
		queryForPage : SLD.followSoa + '/rpc/product/queryForPage' //查询用户关注商品列表
	},
	price : {
		jd : SLD.p + '/prices/mgets', //获取商品促销后的商品价格（主站）
		jdMobile : SLD.pm + '/prices/mgets', //查询商品促销价格（手机）
		jdMobileBatch : SLD.pm + '/prices/pcpmgets', //批量查询商品促销价格（手机）"
		eptprice : SLD.jprice + '/eptprice',  //ept
		getPriceRange : SLD.ipi360buy + '/getPriceRange.html', // newEpt
		vsp : SLD.vsp + '/jshop/batchPrice'  //vsp
	},
	getBatchPrdPromo : SLD.ipr360buy + '/getBatchPrdPromo.html', //新EPT获取商品折扣及促销广告词
	promoTag : SLD.ad + '/flags/mgets', //商品促销标签
	reBuyForOrderCenter : SLD.cart + '/cart/dynamic/reBuyForOrderCenter.action', //主站购物车
	miniCartServiceNew : SLD.cart + '/cart/miniCartServiceNew.action', //迷你购物车
	sevencard_insert : SLD.creadE + '/sevencard/sevencard_insert.action', //电子书频道下领取畅读卡
	sevencard_gettoken : SLD.creadE + 'sevencard/sevencard_gettoken.action',
	jindou : SLD.jprice + '/skuprice',  //京豆
	vote : {
		vote : SLD.activity + '/vote/vote.action',  //传入投票id、投票项id，用户pin，回传状态，提示内容，得票数
		optHistory : SLD.activity + '/vote/optHistory.action', //传入投票id，获取当前用户投票记录
		getCount : SLD.activity + '/vote/getCount.action', //入投票项id串，批量获取投票数
		voteInfo : SLD.activity + '/vote/voteInfo.action' //传入投票id，回传投票所有信息"
	},
	soaYushou : SLD.soaYushou + '/youshouinfo.action', //预售老接口
	yushou : SLD.yushou + '/youshouinfo.action', //预售新接口
	diviner : SLD.diviner + '/diviner', //商品智能推荐接口 //商品浏览历史记录
	rankData : SLD.rankM + '/rankData', //调用二级分类类目的地址及商品列表地址（热门排行榜）
	lottery : {
		getWinnerList : SLD.lsActivity + '/lotteryApi/getWinnerList.action', //中奖信息查询
		getLotteryInfo : SLD.lsActivity + '/lotteryApi/getLotteryInfo.action', //抽奖基本信息查询
		lottery_start : SLD.lActivity + '/lottery/lottery_start.action', //抽奖（web端）
		lottery_chance : SLD.lActivity + '/lottery/lottery_chance.action' //剩余抽奖次数查询（web端）"
	},
	paimai : {
		currentList : SLD.paimai + '/services/currentList.action', //根据拍卖ID批量获取拍品的实时数据
		queryCurAlbumInfo : SLD.paimai + '/json/current/queryCurAlbumInfo' //获取专场实时信息
	},
	group : {
		addGroupCircle : SLD.group + '/jshop/addGroupCircle.htm', //加入圈子接口
		isJoinQuanZi : SLD.group + '/relation/isJoinQuanZi.htm', //是否加入圈子
		collect : SLD.group + '/jshop/collect.htm', //收藏主题帖接口
		saveGroupPost : SLD.group + '/jshop/saveGroupPost.htm' // 发表回复帖接口
	},
	passport : {
		helloService : SLD.passport + '/new/helloService.ashx', // 判断是否登录
		login : SLD.passport + '/new/login.aspx'
	},
	checkChat : SLD.chat1 + '/api/checkChat', //店铺客服状态
	linkJimi : SLD.jimi + '/index.action', //JIMI缩小版
	linkCart : SLD.gate + '/InitCart.aspx', //添加到购物车地址
	linkPresale : SLD.cart + '/cart/dynamic/presale.action', //预售购物车列表
	linkGoods : SLD.item + '', //商品详情页
	actJshop : {
		ad : SLD.actJshop + '/ad.html', //获取广告位
		recommend : SLD.actJshop + '/recommend.html', //获取商品评论相关信息
		serverTime : SLD.actJshop + '/serverTime.html', //获取服务器时间
		couponSend : SLD.actJshop + '/couponSend.html', //获取优惠券信息
		couponExchange : SLD.actJshop + '/couponExchange.html', //返回京豆换券是否成功
		fs : SLD.actJshop + '/fs.html', //新限时抢购
		multi : SLD.actJshop + '/multi.html', //多个促销推荐
		single : SLD.actJshop + '/single.html', //单个促销推荐
		ms : SLD.actJshop + '/ms.html', //促销推荐
		promo : SLD.actJshop + '/promo.html', //促销接龙
		userExd : SLD.actJshop + '/userExd.html', //用户信息
		getOrderInfo : SLD.actJshop + '/getOrderInfo.html', //订单信息
		getOrderTrack : SLD.actJshop + '/getOrderTrack.html', //订单跟踪
		couponInfo : SLD.actJshop + '/couponInfo.html', // 京东优惠券
		getShopCoupon : SLD.actJshop + '/getShopCoupon.html', //店铺优惠券
		goodsInfo : SLD.actJshop + '/goodsInfo.html', //商品信息
		getPopShopInfo : SLD.actJshop + '/getPopShopInfo.html', //店铺优惠券信息
		balance : SLD.actJshop + '/balance.html', //账户余额
		jbn : SLD.actJshop + '/jbn.html', // 用户京豆数量
		attentionCount : SLD.actJshop + '/attentionCount.html' //商品关注数
	},
	getData : function(args){
		var param = jQuery.extend({
			url : '',
			data : {},
			dataType : 'jsonp',
			callBack : function(){}
		}, args || {});
		
		if(param.jsonpCallback){
			jQuery.ajax({
				url : url,
				data : data,
				dataType : 'jsonp',
				jsonpCallback : param.jsonpCallback,
				success : function(d){
					callBack.call(d);
				}
			});
		}else{
			jQuery.ajax({
				url : url,
				data : data,
				dataType : 'jsonp',
				success : function(d){
					callBack.call(d);
				}
			});
		}
	}
};

/*
 * rewrite some methods provided by sys
 */

(function($,w){
	/*
	 * rewrite console method in order to avoid IE
	 */
	if(!w.console){
		w.console = {};
		w.console.log = function(str){
		};		
	}
	
	/*
	 * rewrite alert method with dialog widget
	 */
	if(typeof UI != 'undefined'&&UI.dialog){
		w.alert = function(str){
			UI.dialog.open({
				sTitle : '京东店铺提示',
				sContent : gConfig.assembles.dialog_content(str,1),
				nBtn : 1,
				fSure : function(){
					UI.dialog.close();
				}
			});
		};
	}
	w.setCaret = function(textObj){
		if (textObj.createTextRange) {
	        textObj.caretPos = document.selection.createRange().duplicate();
	    }
	};
	
	w.insertText = function(obj,str){
		if(document.all){
			if(obj.createTextRange&&obj.caretPos){
				 var caretPos = obj.caretPos;
            	caretPos.text = caretPos.text.charAt(caretPos.text.length - 1) == '   ' ? str + '   ' : str;
	        } else {
	            obj.value = str;
	        }
		}
		else if(obj.selectionStart || obj.selectionStart == '0'){
			var startPos = obj.selectionStart,
				endPos = obj.selectionEnd,
				cursorPos = startPos,
				restoreTop = obj.scrollTop,
				tmpStr = obj.value;
			 obj.value = tmpStr.substring(0, startPos) + str + tmpStr.substring(endPos, tmpStr.length);
			 if(restoreTop > 0){
				 obj.scrollTop = restoreTop;
			 }
			 obj.focus();
	        cursorPos += str.length;
	        obj.selectionStart = obj.selectionEnd = cursorPos;
	    } else {
	        obj.value += str;
	        obj.focus();
	    }
	};
})(jQuery,window);


(function($,w){

	w.gBase = w.gBase || {};
	
	$.extend(w.gBase,{
		nMaxZIndex : null,
		isIE6 : (function(){
			if(window.ActiveXObject){
				if(document.documentElement && typeof document.documentElement.style.maxHeight != 'undefined'){
					return false;
				}
				else{
					return true;
				}
			}
			else{
				return false;
			}
		})(),
		fGetUrlParms : function()    
		{
		    var args=new Object(),   
		    	qry=location.search.substring(1),//获取查询串   
		    	pairs=qry.split("&");//在逗号处断开   
		    for(var i=0;i<pairs.length;i++)   
		     {   
		        var pos=pairs[i].indexOf('=');//查找name=val
		            if(pos==-1)   continue;//如果没有找到就跳过   
		            var argname=pairs[i].substring(0,pos),//提取name   
		            	val=pairs[i].substring(pos+1);//提取val
		            args[argname]=unescape(val); //存为属性(解码)
		     }
		    return args;
		},
		/*
		This basic logic can get the max 'z-index' property in the range of BODY
	or somehow specific DOM element.
		@doc: search range, BODY in default
	*/
		fGetMaxZIndex : function(doc){
			if(gBase.nMaxZIndex){
				gBase.nMaxZIndex ++;
				return gBase.nMaxZIndex;
			}
			else{
				return 1001;
			}
			
			function _get(doc){
				var root = doc?doc:'body',
						maxZIndex = 0,
						children = $(root).children();
				for(var i = 0, len = children.length; i < len; i++){
					var zIndex = children.eq(i).css('z-index');
					if(zIndex == 'auto'){
						zIndex = arguments.callee(children[i]);
					}
					gBase.nMaxZIndex = Math.max(gBase.nMaxZIndex,zIndex);
				}
				return gBase.nMaxZIndex;
			}
			gBase.nMaxZIndex =  _get() + 1;
			return gBase.nMaxZIndex;
		},
		
		fMask : function(prefix,color,opacity){
			color = color == null ? '#000' : color;
			opacity = opacity == null ? 20 : opacity;
			var ch = Math.max($('body').height(),$(window).height()),
				zindex = this.fGetMaxZIndex();
			if($.browser.msie && ($.browser.version.match(/\d/) == 6)){
				var ifm = $('iframe id="' + prefix + '_ie6_mask" className="_mask_2012" style="background:#000;position:absolute;width:100%;height:'+ch+'px;z-index:'+zindex+';"></iframe>').appendTo('body');
				$.browser.msie?$(ifm).css('filter','alpha(opacity=' + opacity + ')'):$(ifm).css('opacity',opacity/100);
			}
			$('<div id="'+prefix+'_mask" className="_mask_2012" style="background:'+color+';position:absolute;top:0px;display:none;width:100%;height:'+ch+'px;z-index:'+zindex+';"></div>').appendTo('body').fadeTo(200,opacity/100);
		},
		
		fMaskHide : function(prefix){
			$('#' + prefix + '_ie6_mask,#'+prefix+'_mask').remove();
		},
		addFavorite: function(title, url) {
			var _url = url;
		    var _title = title;
			try{
				if (document.all) {
					window.external.AddFavorite(_url, _title);
				} else if (window.sidebar) {
					window.sidebar.addPanel(_title, _url, "");
				} else {
					alert("对不起，您的浏览器不支持此操作!\n请您使用菜单栏或Ctrl+D收藏本站。");
				}
			}
			catch(e){
				alert('对不起，您的浏览器不支持此操作!\n请您使用菜单栏或Ctrl+D收藏本站。');
			}
		},
		
		JSONClone : function(obj){
			var _result = {};
			for(var i in obj){
				_result[i] = obj[i];
			}
			return _result;
		}
	});
})(jQuery,window);

$.fn.extend({
	imgOnload : function(){}
});

$(function(){
	gBase.nMaxZIndex = gBase.fGetMaxZIndex();
});

(function(w,$,undefined){
	/*
     * @function：关注
     * @description：活动关注、店铺关注、商品关注
     * @param：
     * @author：20151015 cdwanchuan@jd.com
     *一、业务
        1、逻辑业务：
            1）页面打开时，获取页面上当前作用域下所有带有点击class节点上的data-id，初始化关注状态；
            2）根据3种关注功能类型，展示不同的效果，参见dataType参数

     * 二、公共方法（Module.js里面增加attent方法）
        1、点击元素：e-attention（用此class名做唯一区分）
        2、关注ID：data-id（节点伪属性，将ID保存在此）
        3、区分关注功能类型：data-type（节点伪属性，用户手动传入），获取点击元素上的功能类型  0：所有状态+弹出层；1：关注和取消关注+修改按钮文案+关注成功弹出层；2：默默关注
        4、点击元素，受限于模块module-name，只有在模块下才能使用
        5、使用方法：<div class="j-module" module-function="saleAttent" module-param="{}"><a href="javascript:;" class="e-attention" data-id="" data-state="0" data-type="0">关注活动</a></div>
    */
    function saleAttent(args){
        var param = jQuery.extend({
            attentType : 'vender', //关注的ID类型：activity（活动）、vender（店铺）、product（商品）
			activityType : 1, //当关注的ID类型是活动时，必须传此值；0店铺活动，1采销活动
			node : '.e-attention', //关注点击元素
            dataId : 'data-id',//（节点伪属性，将活动ID保存在此）
            dataState : 'data-state', //临时状态data-state ：0未关注；1关注成功；2已经关注；3关注数量达到上限；4关注失败
            dataType : 'data-type',//获取点击元素上的功能类型  0：所有状态+弹出层；1：关注和取消关注+修改按钮文案+关注成功弹出层；2：默默关注
			current : 'current', //已经关注样式名，初始化关注状态时，如果已经关注过的，则默认加上此样式
			sysName : 'mall.jd.com' //关注注册系统名
        }, args || {}),
            _this = jQuery(this),
            attentType = param.attentType,
			activityType = param.activityType,
			node = _this.find(param.node),
			current = param.current,
            currentDom,//全局变量，获取当前触发的事件元素
            dataTypeValue,//全局变量，获取当前触发的事件元素上的功能类型
            para = [], //传入参数
            _INTERFACE = {
                follow : 'http://follow.soa.jd.com/rpc/' + attentType + '/follow', //关注活动
                batchIsFollow : 'http://follow.soa.jd.com/rpc/' + attentType + '/batchIsFollow', //查询用户关注活动状态（批量）
                unfollow : 'http://follow.soa.jd.com/rpc/' + attentType + '/unfollow', //取消关注活动
				queryForCount : 'http://follow.soa.jd.com/rpc/' + attentType + '/queryForCount' //查询用户关注活动数量
            };

        if(!node.length){return;}

        var attentHtml = '<div class="follow-dialog-mask"></div>'
        +'<div class="follow-dialog">'
        +   '<div class="attent-mt">'
        +       '<span class="attent-close" title="关闭">关闭</span>'
        +       '<span class="attent-title">提示</span>'
        +   '</div>'
        +   '<div class="attent-mc">'
        +       '<div class="attent-con">'
        +           '<span class="attent-msg"></span>'
        +           '<span class="attent-other"></span>'
        +       '</div>'
        +   '</div>'
        +'</div>';

        var attentCss = '<style id="followCls">'
        +'.follow-dialog-mask{position:fixed; _position:absolute; left:0; top:0; right:0; bottom:0; background:#000; opacity:0.3; filter:alpha(opacity=30); z-index:100; display:none;}'
        +'.follow-dialog-mask.current{display:block;}'
        +'.follow-dialog{width:320px; border:solid 4px rgba(0,0,0,0.1); background:#fff; position:fixed; _position:absolute; left:50%; top:50%; margin:-60px 0 0 -160px; z-index:101; display:none;}'
        +'.follow-dialog.current{display:block;}'
        +'.follow-dialog .attent-mt{height:32px; line-height:32px; background:#f5f5f5; font-size:16px; color:#222; text-indent:10px; overflow:hidden;}'
        +'.follow-dialog .attent-close{float:right; width:32px; height:32px; text-indent:-9999px; background:url(http://misc.360buyimg.com/lib/skin/2013/i/thickbox_close.png) center center no-repeat; cursor:pointer;}'
        +'.follow-dialog .attent-ok, .follow-dialog .attent-repeat, .follow-dialog .attent-error, .follow-dialog .attent-max{height:48px; margin-left:20px; padding:20px 20px 20px 48px;}'
        +'.follow-dialog .attent-ok{background:url(http://img12.360buyimg.com/cms/jfs/t1435/352/153421548/1347/d377c92d/555e9e71Nb767e906.png) left center no-repeat;}'
        +'.follow-dialog .attent-repeat, .follow-dialog .attent-error, .follow-dialog .attent-max{background:url(http://img14.360buyimg.com/cms/jfs/t1516/358/164942511/1418/e0c25f0c/555e9e75Nfca9da16.png) left center no-repeat;}'
        +'.follow-dialog .attent-ok .attent-msg{font-size:14px; color:#009900; font-weight:bold;}'
        +'.follow-dialog .attent-repeat .attent-msg, .follow-dialog .attent-error .attent-msg, .follow-dialog .attent-max .attent-msg{font-size:14px; color:#ff771e; font-weight:bold;}'
        +'.follow-dialog .attent-other{color:#6f6363; display:block; margin-top:10px;}'
        +'.follow-dialog .attent-other a{color:#004499;}'
        +'.follow-dialog .attent-other .attent-text{margin-right:10px;}'
        +'</style>';

        var attentInfo = {
            activity : {
                msgOk : '&#x5173;&#x6CE8;&#x6210;&#x529F;&#xFF01;',
                msgRepeat : '&#x5DF2;&#x5173;&#x6CE8;&#x8FC7;&#x8BE5;&#x6D3B;&#x52A8;&#xFF01;',
                msgError : '&#x5173;&#x6CE8;&#x6D3B;&#x52A8;&#x5931;&#x8D25;&#xFF01;',
                msgMax : '&#x5173;&#x6CE8;&#x7684;&#x6D3B;&#x52A8;&#x8FBE;&#x5230;&#x6700;&#x5927;&#x6570;&#x91CF;&#xFF01;',
                msgOther : '<span class="attent-text">&#x60A8;&#x5DF2;&#x5173;&#x6CE8;<span class="attent-num">{attentNum}</span>&#x4E2A;&#x6D3B;&#x52A8;</span><a href="http://t.jd.com/activity/followActivityList.action" target="_blank">&#x67E5;&#x770B;&#x6211;&#x7684;&#x5173;&#x6CE8;>></a>'
            },
			vender : {
                msgOk : '&#x5173;&#x6CE8;&#x6210;&#x529F;&#xFF01;',
                msgRepeat : '&#x5DF2;&#x5173;&#x6CE8;&#x8FC7;&#x8BE5;&#x5E97;&#x94FA;&#xFF01;',
                msgError : '&#x5173;&#x6CE8;&#x5E97;&#x94FA;&#x5931;&#x8D25;&#xFF01;',
                msgMax : '&#x5173;&#x6CE8;&#x7684;&#x5E97;&#x94FA;&#x8FBE;&#x5230;&#x6700;&#x5927;&#x6570;&#x91CF;&#xFF01;',
                msgOther : '<span class="attent-text">&#x60A8;&#x5DF2;&#x5173;&#x6CE8;<span class="attent-num">{attentNum}</span>&#x4E2A;&#x5E97;&#x94FA;</span><a href="http://t.jd.com/vender/followVenderList.action" target="_blank">&#x67E5;&#x770B;&#x6211;&#x7684;&#x5173;&#x6CE8;>></a>'
            },
			product : {
                msgOk : '&#x5173;&#x6CE8;&#x6210;&#x529F;&#xFF01;',
                msgRepeat : '&#x5DF2;&#x5173;&#x6CE8;&#x8FC7;&#x8BE5;&#x5546;&#x54C1;&#xFF01;',
                msgError : '&#x5173;&#x6CE8;&#x5546;&#x54C1;&#x5931;&#x8D25;&#xFF01;',
                msgMax : '&#x5173;&#x6CE8;&#x7684;&#x5546;&#x54C1;&#x8FBE;&#x5230;&#x6700;&#x5927;&#x6570;&#x91CF;&#xFF01;',
                msgOther : '<span class="attent-text">&#x60A8;&#x5DF2;&#x5173;&#x6CE8;<span class="attent-num">{attentNum}</span>&#x4E2A;&#x5546;&#x54C1;</span><a href="http://t.jd.com/home/follow" target="_blank">&#x67E5;&#x770B;&#x6211;&#x7684;&#x5173;&#x6CE8;>></a>'
            }
        };
		var attentText = {
            activity : '\u5173\u6ce8\u6d3b\u52a8', //关注活动
			vender : '\u5173\u6ce8\u5e97\u94fa', //关注店铺
			product : '\u5173\u6ce8\u5546\u54c1', //关注商品
			followed : '\u5df2\u5173\u6ce8', //已关注
			unFollow : '\u53d6\u6d88\u5173\u6ce8' //取消关注
        };

        //临时状态data-state ：0未关注；1关注成功；2已经关注；3关注数量达到上限；4关注失败
        function domOperate(){
            //取消关注
            if(currentDom.attr(param.dataState) == 0){
                if(dataTypeValue == 1){currentDom.html(attentText[attentType]);}//如果当前需要取消关注功能，则修改文案
                return;
            }

            jQuery('body').append(attentHtml,attentCss);
            var _this = jQuery('.follow-dialog'),
                mask = jQuery('.follow-dialog-mask'),
                con = _this.find('.attent-con'),
                msg = _this.find('.attent-msg'),
                other = _this.find('.attent-other'),
                close = _this.find('.attent-close'),
				cssDom = jQuery('#followCls');

            //关注成功
            if(currentDom.attr(param.dataState) == 1){
                if(dataTypeValue == 1){currentDom.html(attentText.followed); }//如果当前需要取消关注功能，则修改文案
                msg.html(attentInfo[attentType].msgOk);
                con.addClass('attent-ok');
            }
            //已经关注
            if(currentDom.attr(param.dataState) == 2){
                msg.html(attentInfo[attentType].msgRepeat);
                con.addClass('attent-repeat');
            }
            //关注达到最大数量
            if(currentDom.attr(param.dataState) == 3){
                msg.html(attentInfo[attentType].msgMax);
                con.addClass('attent-repeat');
            }
            //关注失败
            if(currentDom.attr(param.dataState) == 4){
                msg.html(attentInfo[attentType].msgError);
                con.addClass('attent-error');
            }
			
			other.html(attentInfo[attentType].msgOther);
			_this.addClass(current);
			mask.addClass(current);
			
			//关闭弹层
            close.click(function(){
                _this.remove();
                mask.remove();
				cssDom.remove();
            });
        }

        //获取参数ID，此段供初始化元素状态及文案所用
        !function getId(){
            for(var i = 0, len = node.length; i<len; i+=1){
				//activity（活动）、vender（店铺）、product（商品）
				switch (attentType) {
					case 'activity':
						para.push({id : jQuery(node[i]).attr(param.dataId),srcType:activityType});
						break;
					case 'vender':
						para.push(jQuery(node[i]).attr(param.dataId));
						break;
					case 'product':
						para.push(jQuery(node[i]).attr(param.dataId));
						break;
					default:
						break;
				}
            }
        }();

        function init(){
            getState();//遍历节点，初始化关注状态
            event();
        }

        function event(){
            //当dataTypeValue == 1时，增加鼠标hover改变文字提示
			node.mouseenter(function(){
                var _state = jQuery(this).attr(param.dataState);
                dataTypeValue = jQuery(this).attr(param.dataType);

                if(_state == 1 || _state == 2){
                    if(dataTypeValue == 1){jQuery(this).html(attentText.unFollow);}//如果当前需要取消关注功能，则修改文案
                }
            }).mouseleave(function(){
                var _state = jQuery(this).attr(param.dataState);
                dataTypeValue = jQuery(this).attr(param.dataType);

                if(_state == 1 || _state == 2){
                    if(dataTypeValue == 1){jQuery(this).html(attentText.followed);}//如果当前需要取消关注功能，则修改文案
                }
            });

            node.click(function(){
				//获取当前点击元素上的品牌活动ID伪属性data-id
                currentDom = jQuery(this);
				
				//activity（活动）、vender（店铺）、product（商品）
				switch (attentType) {
					case 'activity':
						para = {activityId : currentDom.attr(param.dataId), sysName : param.sysName, srcType : activityType};
						break;
					case 'vender':
						para = {venderId : currentDom.attr(param.dataId), sysName : param.sysName};
						break;
					case 'product':
						para = {productId : currentDom.attr(param.dataId), sysName : param.sysName};
						break;
					default:
						break;
				}
				
                dataTypeValue = currentDom.attr(param.dataType);

                if(dataTypeValue == 1){//如果当前需要取消关注功能
                    if(currentDom.attr(param.dataState) == 1 || currentDom.attr(param.dataState) == 2){
                        thick_login(abortAttent); //依赖 http://sale.jd.com/script/module/utils.js
                    }else{
                        thick_login(attent);
						getAttentNum();
                    }
                }else{
                    thick_login(attent);
					getAttentNum();
                }
            });
        }

		//data : 'sysName=sale.jd.com&data=[{"id":"375590","srcType":"1"},{"id":"375498","srcType":"1"},{"id":"376757","srcType":"1"}]' 采销活动数据形式
        function getState(){
            //activity（活动）、vender（店铺）、product（商品）
			var data;
			switch (attentType) {
				case 'activity':
					data = 'sysName=' + param.sysName + '&data=' + JSON.stringify(para);
					break;
				case 'vender':
					data = {venderIds : para.toString(), sysName:param.sysName};
					break;
				case 'product':
					data = {productIds : para.toString(), sysName : param.sysName};
					break;
				default:
					break;
			}
			$.ajax({
                url : _INTERFACE.batchIsFollow,
				data : data,
                dataType : 'jsonp',
                success : function(data){
                    if(data.code == 'F10000'){
                        for(var i = 0, len = node.length; i < len; i+=1){
                            var _node = jQuery(node[i]),
                                dataId = _node.attr(param.dataId);
							dataTypeValue = _node.attr(param.dataType);

                            if(data.data[dataId]){
                                if(dataTypeValue == 1){_node.html(attentText.followed);}//如果当前需要取消关注功能，则修改文案
                                _node.attr(param.dataState,2).addClass(current);//已关注
                            }else{
                                if(dataTypeValue == 1){_node.html(attentText[attentType]);}//如果当前需要取消关注功能，则修改文案
                                _node.attr(param.dataState,0);//未关注
                            }
                        }
                    };
                }
            });
        }

        function attent(){
            $.ajax({
                url : _INTERFACE.follow,
				data : para,
                dataType : 'jsonp',
                success : function(data){
					if(data.code == 'F10000'){
                        if(data.data){
                            currentDom.attr(param.dataState,1).addClass(current);
                        }
                    }else if(data.code == 'F0402'){
                        if(!data.data){
                            currentDom.attr(param.dataState,2);
                        }
                    }else if(data.code == 'F0410'){
                        currentDom.attr(param.dataState,3);
                    }else{
                        currentDom.attr(param.dataState,4);
                    }
					
					if(dataTypeValue == 2){
						//默默关注
					}else{
						domOperate();
					}
                }
            });
        }
		
		function getAttentNum(callBack,scope){
            $.ajax({
                url : _INTERFACE.queryForCount,
				data : {sysName : param.sysName},
                dataType : 'jsonp',
                success : function(data){
                    attentInfo[attentType].msgOther = attentInfo[attentType].msgOther.replace("{attentNum}", data.data);
                }
            });
        }

        function abortAttent(){
            $.ajax({
                url : _INTERFACE.unfollow,
				data : para,
                dataType : 'jsonp',
                success : function(data){
                    if(data.code == 'F10000'){
                        if(data.data){
                            currentDom.attr(param.dataState,0).removeClass(current);
                            domOperate();
                        }
                    }
                }
            });
        }

        init();
    }
	jQuery.fn.saleAttent = saleAttent;
})(window,jQuery);
/*
 author:wanghaixin@jd.com
 date:20130320
 ver:v1.0.0

 description:

 */

/****************************************************Message Box*****************************************/
/*
 * 在UI.dialog基础上做二次开发
 * 依赖于UI.dialog
 */
message_box = (function(){
    var _box = null,_timer,_duration = 2000,_speed = 300,_messages = [];
    /*
     * 初始化 message box
     */
    function _init(cnt){
        if(!_box){
            var dialog = UI.dialog.open({
                type : 1,
                sContent : cnt,
                nBtn : 2,
                sStyle : 'userDef',
                sAnimate : {left:0,top:1}
            });
            _box = dialog.oPopup;
            _box.css('zIndex',2147483640);
        }

    }

    /*
     * 添加消息至消息队列，如果消息队列为空并且timer为null。开始显示message
     */
    function _add(cnt){
        var __flag = !_messages.length&!_timer;
        _messages.push(cnt);
        if(!!__flag){
            _show();
        }
    }

    /*
     * 显示message box
     */
    function _show(){
        var __callee = arguments.callee;
        if(_messages.length){
            var _cnt = _messages.shift();
            _box.html(_cnt);

            _box.show().animate({top:'-4px'},_speed,function(){
                _timer = setTimeout(function(){
                    _box.animate({top : -_box.outerHeight() + 'px'},_speed,function(){
                        _clear();
                        __callee();
                    });
                },_duration);
            });
        }
    }

    /*
     * 清除timer
     */
    function _clear(){
        clearTimeout(_timer);
        _timer = null;
        _box.clearQueue();
    }


    return function(str,type){
        var _str = '<div class="dialog-area">' + gConfig.assembles.dialog_content(str,type) + "</div>";
        _init('');
        _add(_str);
    };
})();


/****************************************************Image Lazyload*****************************************/

(function($,w){
    var _lazy_class = 'J_imgLazyload',
        _orginal_src = 'original',
        _imgs = [];

    function _get_imgs(){
        _imgs = $('body .' + _lazy_class);
    }
    function _load(){
        var __top = $(window).scrollTop() + $(window).height(),
            __left = [];
        for(var i = 0, len = _imgs.length; i < len; i++){
            var __img = $(_imgs[i]);
            try{
                if(__img.offset().top < __top){
                    __img.removeClass(_lazy_class);
                    __img.attr('src',__img.attr(_orginal_src));
                    __img.removeAttr(_orginal_src);
                }
                else{
                    __left.push(__img);
                }
            }
            catch(e){

            }
        }
        _imgs = __left;
        if(!_imgs.length){
            $(window).unbind('scroll,resize',_load);
        }
    }

    $(function(){
        _get_imgs();
        _load();
        $(window).scroll(_load).resize(_load);
    });

})(jQuery,window);

/******************************************obtain price**********************************/
(function(w){

    var _nodes = [],
        _prefix_url = 'http://p.3.cn/prices/mgets?skuids=',
        _suffix_url = '&type=2&callback=callBackPriceService',
        _batch_count = 0,
        _tem_str = '',
        _max_count = 20;

    function _get_nodes(){
        _nodes = _price_unique($('span[jshop="price"]').toArray());
    }


    function _getPrice(){
        var __skus = _tem_str.substring(_tem_str,_tem_str.length-1);
        $.getScript(_prefix_url + __skus + _suffix_url);
        _batch_count = 0;
        _tem_str = '';
    }

    function _load(){
        var __top = $(window).scrollTop() + $(window).height(),
            __lefts = [];
        for(var i = 0, len = _nodes.length; i < len; i++){
            var __node = $(_nodes[i]);
            if(__node.offset().top < __top){
                var __skuid = __node.attr('jdprice') || __node.attr('jsprice') || __node.attr('jskuprice');
                _tem_str += 'J_' + __skuid + ',';
                _batch_count ++;
                if(_batch_count == _max_count){

                    _getPrice();
                }
            }else{
                __lefts.push(_nodes[i]);
            }
        }
        if(_batch_count){
            _getPrice();
        }
        _nodes = __lefts;
        if(!_nodes.length){
            $($('#appId').length?'.J-layout-container':window).unbind('scroll',_load);
        }
    }

    function _event_register(){
        $($('#appId').length?'.J-layout-container':window).scroll(_load);
    }

    function _init(){
        _get_nodes();
        _load();
        _event_register();
    }

    function _price_unique(arr){
        if(!arr instanceof Array) throw new Error('_price_unique:arguments error');
        var __tem1 = {},__tem2 = [],__tem3 = [];
        for(var i = 0, len = arr.length; i < len; i++){

            var __obj = $(arr[i]),
                __sku = __obj.attr('jdprice')||__obj.attr('jsprice')||__obj.attr('jskuprice');
            if(__tem1[__sku] == undefined){
                __tem2.push(arr[i]);
                __tem1[__sku] = __obj.offset().top;
                __tem3.push(__sku);
            }
            else if(__tem1[__sku]>__obj.offset().top){
                __tem2[__tem3.getIndex(__sku)] = arr[i];
                __tem1[__sku] = __obj.offset().top;
            }
        }
        return __tem2;
    }

    w.JD_local_price = function(obj){
        var __nodes = obj.find('span[jshop="price"]').toArray();
        for(var i = 0, len = __nodes.length; i < len; i++){
            var __node = $(__nodes[i]),
                __skuid = __node.attr('jdprice') || __node.attr('jsprice') || __node.attr('jskuprice');
            _tem_str += 'J_' + __skuid + ',';
            _batch_count ++;
            if(_batch_count == _max_count){
                _getPrice();
            }
        }
        if(_batch_count){
            _getPrice();
        }
    };

    w.callBackPriceService = function(data){
        var _sku = 0;
        for(var i = 0 , len = data.length; i < len; i++){
            skuid = data[i].id.substr(2);
            data[i].id = skuid;
            getNumPriceService(data[i]);
        }
    };

    $(function(){
        _init();
    });
})(window);

/**************************************price data fill******************************************/
(function($,w){
    w.JD_price = {
        /*
         * 获取节省价
         */
        _get_save : function(num1,num2){
            if(num1 == 0 || num2 == 0 || (num1 - num2 <= 0)) return 0;

            var __rs = num1 - num2;
            return __rs.toString().match(/\d+(\.\d{1,2})?/)[0];
        },
        /*
         * 获取折扣率
         */
        _get_discount : function(num1,num2){
            if(nmu1 == 0 || num2 == 0) return 10;
            return (num2/num1*10).toFixed(1);
        },
        /*
         * 设置京东价
         */
        _set_jd_price : function(data,tag){
            var _price = data.p>=0?data.p:tag;
            $('span[jdprice=' + data.id +']').each(function(index,n){
                $(n).html(_price);
            });
        },
        /*
         * 设置促销价
         */
        _set_sale_price : function(data,tag){
            var _price = data.m >=0?data.m:tag;
            $('span[jsprice=' + data.id +']').each(function(index,n){
                $(n).html(_price);
            });
        },
        /*
         * 设置sku价
         */
        _set_sku_price : function(data,tag){
            var _price = data.m >= 0?data.m:tag;
            $('span[jskuprice=' + data.id +']').each(function(index,n){
                $(n).html(_price);
            });
        },
        /*
         * 设置节省价
         */
        _set_save_price : function(data){
            var __jdpirce = data.p >=0?data.p:0,
                __skuprice = data.m >= 0 ? data.m:0;

            $('span[saprice=' + data.id + ']').each(function(index,n){
                $(n).html(JD_price._get_save(__skuprice, __jdpirce));
            });
        },
        _set_save_sale_price : function(data){
            var __jdpirce = data.p >= 0?data.p:0,
                __sales_price = data.m >= 0 ? data.m:0;

            $('span[ssprice=' + data.id + ']').each(function(index,n){
                $(n).html(JD_price._get_save(__sales_price, __jdpirce));
            });
        },
        /*
         * 设置促销折扣率
         */
        _set_discount_sale_price : function(data){
            var __jdprice = data.p >= 0 ? data.p:0,
                __sales_price = data.m >= 0? data.m:0;
            $("span[dsaleprice=" + data.id + "]").each(function(index, n) {
                $(n).html(JD_price._get_discount(__sales_price,__jdprice));
            });
        },
        /*
         * 设置sku折扣率
         */
        _set_discount_sku_price : function(data){
            var __jdprice = data.p >=0 ? data.p:0,
                __sku_price = data.m >= 0 ? data.m:0;
            $("span[dskuprice=" + data.id + "]").each(function(index, n) {
                $(n).html(JD_price._get_discount(__sku_price,__jdprice));
            });
        }
    };
    /*
     * 填充价格
     */
    w.getNumPriceService = function(data){
        if(!data) return;
        var _no_price_tag = '暂无定价';
        JD_price._set_jd_price(data,_no_price_tag);
        JD_price._set_sale_price(data,_no_price_tag);
        JD_price._set_sku_price(data,_no_price_tag);
        JD_price._set_save_price(data);
        JD_price._set_save_sale_price(data);
        JD_price._set_discount_sale_price(data);
        JD_price._set_discount_sku_price(data);
    };
})(jQuery,window);

/*
 登录统一处理逻辑
 */
function thick_login(callback,scope){
    if(typeof callback != 'function')
        throw new Error('Self-defined login argments should be a function!');
    $.extend(jdModelCallCenter,{
        jshop_login:function(obj){
            $.login({
                modal:true,
                complete:function(c){
                    if(c&&c.IsAuthenticated){
                        callback.call(scope || this, c);
                    }
                    else{
                        jdModelCallCenter.settings.fn = callback;
                    }
                }
            });
        }
    });

    $.extend(jdModelCallCenter.settings,{
        object:this,
        fn:function(){
            jdModelCallCenter.jshop_login(this);
        }
    });
    jdModelCallCenter.settings.fn();
}
/*
 关注统一处理逻辑，class名为btn-attention
 */
$(function(){
    $('.layout-main').delegate('btn-attention','click',function(){
        var _this = $(this),
            _sku = parseInt(_this.attr('id').replace('coll',''));
        $.extend(jdModeCallCenter.settings,{
            clstag1 : 'login|keycount|5|3',
            clstag2 : 'login|keycount|5|4',
            id : _sku,
            fn : function(){
                jdModeCallCenter.doAttention(this.id);
            }
        })
    });
});

(function(){
    var cssId = '.J-cart';
    // 为加入购物车按钮绑定事件
    $(function(){
        $('.layout-main').delegate(cssId,'click',function(){
            var sku = $(this).attr('itemid');
            try{
                $.ajax({
                    url : 'http://cart.jd.com/cart/dynamic/reBuyForOrderCenter.action?wids='+sku+'&nums=1',
                    type : 'get',
                    dataType : 'jsonp',
                    success : function(){

                    }
                });
            } catch(e) {

            }

            var dialog  = '';
            dialog += '<div class="m tip-success" id="add-to-cart">';
            dialog += '<div class="mt fl icon"></div>';
            dialog += '<div class="mc lh">';
            dialog += '<div class="c-title"><strong>添加成功</strong></div>';
            dialog += '<div class="c-btn">';
            dialog += '<a class="c-checkout" href="http://cart.jd.com/cart/cart.html" target="_blank">去购物车结算</a>';
            dialog += '<a class="c-return" href="#none" onclick="jdThickBoxclose()">继续购物</a>';
            dialog += '</div><a href="#" class="thickclose" id="">×</a></div></div>';
            dialog += '<style>';
            dialog += '#add_to_cart_div{display:none}';
            dialog += '#add-to-cart,#cart-reco{width:452px;margin-left:10px;overflow:hidden}';
            dialog += '#add-to-cart{margin-bottom:20px}';
            dialog += '#add-to-cart .icon{width:50px;height:50px;margin-right:10px;background-image:url(i/item-icon.png);';
            dialog += 'background-repeat:no-repeat;*display:inline}';
            dialog += '#add-to-cart .c-title strong{font:400 18px "microsoft yahei"}';
            dialog += '#add-to-cart.tip-success .c-title{color:#7abd54}';
            dialog += '#add-to-cart .c-count{color:#999;line-height:22px}';
            dialog += '#add-to-cart .c-btn{padding-top:5px}#add-to-cart ';
            dialog += '.c-btn a{height:36px;background-image:url(';
            dialog += 'http://misc.360buyimg.com/purchase/skin/i/20130425D.png);';
            dialog += 'display:inline-block;overflow:hidden;line-height:100px;*zoom:1}';
            dialog += '#add-to-cart .c-btn .c-checkout{width:189px;margin-right:8px;background-position:0 0}';
            dialog += '#add-to-cart .c-btn .c-return{width:94px;background-position:-90px -37px}';
            dialog += '#cart-reco{border-top:1px solid #ddd;padding-top:20px;margin-bottom:0}';
            dialog += '#cart-reco .mc{height:170px}';
            dialog += '#cart-reco .lh li{width:100px;padding:6px 6px 0}';
            dialog += '#cart-reco .lh li .p-name{height:3em;line-height:1.5em;overflow:hidden}';
            dialog += '</style>';

            $.jdThickBox({
                source : dialog,
                width : 492,
                height : 90,
                title : '加入购物车'
            });
        });

    });
})();
/*
 * author:wanghaixin@jd.com
 * date:20130516
 * ver:v1.0.0
 */

(function($,w){

	$(function(){
		/*
		 * no-margin logics
		 */
		function _no_margin_handle(){
			$('.J-layout').each(function(index,n){
				var m = $(n),_flag = true;
				m.children('div').each(function(index,n){
					if($(n).children('[instanceid],[m_render_instance_id]').length)
						_flag = false;
				});
				if(!_flag)
					m.parents('.J-layout-area').addClass('no-margin');
			});
		}
		/*
		 * 背景锁定功能
		 */
		function _background_fixed_handle(){
			if($('.layout-main').length){
				var _is_fixed = parseInt($('.layout-main').attr('isfixed')),
				_TOP = $('.layout-main').offset().top,
				_decorate_flag = typeof gConfig != 'undefined';
			}
			
			
			if(_is_fixed){
				$(_decorate_flag?'.layout-container':window).scroll(function(){
					var __top = $(this).scrollTop();

					if(__top >= _TOP){
						$('.layout-main').css('background-attachment','fixed');
					}
					else{
						$('.layout-main').css('background-attachment','scroll');
					}
				});
			}
			
		}
		_no_margin_handle();
		_background_fixed_handle();
	});
	w.window2013CSS = function(obj,css){
		var _css = css,
			_mutant_css = gBase.JSONClone(css),
			_side_bar = $('#slide_bar_area'),
			_extra_value = _side_bar.length&&!_side_bar.hasClass('off')?185:0;
		if(!$('#slide_bar_area').length){
			obj.css(_css);
			return;
		}
		if(_mutant_css.left){
			_mutant_css.left = _mutant_css.left.match(/%/g)?($(window).width() + _extra_value)*parseInt(_mutant_css.left)/100 + 'px':_mutant_css.left; 
		}
		if(_mutant_css.right){
			_mutant_css.right = _mutant_css.right.match(/%/g)?($(window).width() - _extra_value)*parseInt(_mutant_css.right)/100 + 'px':_mutant_css.right;
		}
		if(typeof gBase.fGetUrlParms()['veBean.open'] == 'undefined' || gBase.fGetUrlParms()['veBean.open'] === '1'){
			obj.css(_mutant_css);
		}
		else{
			obj.css(_css);
			
		}
		$(window).bind('sidebarchange',function(e,collapse){
			if(collapse){
				obj.css(_mutant_css);
			}
			else{
				obj.css(_css);
			}
		});
	};
	
	w.window2013scroll = function(handler){
		if($('#slide_bar_area').length){
			$('.J-layout-container').scroll(function(){
				handler.call(this);
			});
		}
		else{
			$(window).scroll(function(){
				handler.call(this);
			});
		}
	};
	
	w.window2013scrollTop = function(){
		return $('#slide_bar_area').length?$('.J-layout-container').scrollTop():$(window).scrollTop();
	};
})(jQuery,window);/*
 * author:wanghaixin@jd.com
 * date:2013-04-11
 * ver:v1.0.0
 */

/*
 * 伪属性模块加载框架
 */
(function($,w){
	w.jshop = {};
	w.jshop.module = {};
	
	$.extend(w.jshop.module,{
		/*
		 * 去除图片懒加载
		 */
		 ridLazy : function(obj) {
			$(obj).find('img.J_imgLazyload').each(function(){
				$(this).attr('src',$(this).attr('original'));
				$(this).removeAttr('original');
				$(this).removeClass('J_imgLazyload');
			});	
		},
		/*
		 * @function：瀑布流：将图片或商品列表错位布局，错位高度可设置。
		 * @description：主要应用于图片或商品列表类模块，如商品推荐、图片show等模块。
		 * @param：如{area:'.goodsArea', node:"li", topSpac:10}。area需要重设高度的父级节点；node需要使用瀑布流的节点；topSpac顶部错位的距离。
		 * @author：20130114 by bjwanchuan
		 */
		waterfallFlow:function(args){
			var param = jQuery.extend({area:'.goodsArea', node:"li", topSpac:10}, args),
		   		_this = $(this),
				area = _this.find(param.area),
				elem = _this.find(param.node),
				outerWidth = parseInt(elem.data('outerWidth') || elem.outerWidth(true)),
				qty = parseInt(elem.parent().width()/outerWidth),
				topPos,
				array = [];
				elem.data({'outerWidth':outerWidth});
				
		   elem.each(function(index, e){
			   //获取行数
				var row = parseInt(index/qty),
					//获取列数：通过每一个的位置除去每一行的数量，剩下的余数就是每一列
					col = index%qty,
					//获取每一个的左边距：离最左边的距离
					leftPos = col*jQuery(e).outerWidth(true);
				
				//如果是第一行
			   if(row == 0){
				   topPos = parseInt((col%2)*param.topSpac);
			   }
			   else{
				   var topNode = jQuery(elem.get((row-1)*qty+col));
				   topPos = topNode.outerHeight(true)+parseInt(topNode.css("top"));
			   }
			   jQuery(e).css({left:leftPos,top:topPos});
				
				//将每一个的top和自身的高度之和保存到数组里
				array.push(parseInt(jQuery(e).css("top"))+jQuery(e).outerHeight(true));
		   });
			
			//数组排序，获取最大的高度
			function compare(value1, value2){
				if(value1<value2){
					return -1;
				}else if(value1>value2){
					return 1;
				}else{
					return 0;
				}
			}
			array.sort(compare);
			
			//重设父级的高度，以达到背景自适应
			area.css("height",array[array.length-1]);
	   },
		/*
		 * 旧方法，和changeClass一样。
		 */
		changeStyle:function(args){
			var param = $.extend({node:'li', defaultClass:'jCurrent', defaultShow:0}, args),
				elem = $(this).find(param.node),
				defaultClass = param.defaultClass,
				defaultShow = param.defaultShow;
			
			elem.eq(defaultShow).addClass(defaultClass);
			
			elem.each(function(index,n){
				$(n).mouseover(function(e){
					$(this).addClass(defaultClass).siblings().removeClass(defaultClass);
				});
			});
		},
		/*
		 * @function：改变样式：默认显示一个，鼠标移动到节点上时增加当前样式，同时去除其兄弟节点的当前样式
		 * @description：主要应用于190布局宽度下，因宽度有限，默认只显示商品标题，当鼠标移动到标题上时显示更多的商品信息。
		 * @param：如{node:'li', defaultClass:'jCurrent', defaultShow:0}。参数node为单个节点名；参数defaultClass可任意命名，只要css里面有这个名字。
		 * @author：20130114 by bjwanchuan
		 */
		changeClass:function(args){
			var param = $.extend({node:'li', defaultClass:'jCurrent', defaultShow:0}, args),
				elem = $(this).find(param.node),
				defaultClass = param.defaultClass,
				defaultShow = param.defaultShow;
			
			elem.eq(defaultShow).addClass(defaultClass);
			
			elem.each(function(index,n){
				$(n).mouseover(function(e){
					$(this).addClass(defaultClass).siblings().removeClass(defaultClass);
				});
			});
		},
		/*
		 * @function：切换样式：鼠标移动到节点上时增加一个样式，移出时去除增加的样式
		 * @description：主要应用于商品列表类模块，如商品推荐、分页显示商品等模块，默认显示商品图片等，鼠标移动上去时显示更多商品信息。
		 * @param：如{node:'li', defaultClass:'current', defaultShow:0}。参数node为单个节点名；参数defaultClass可任意命名，只要css里面有这个名字。
		 * @author：20130114 by bjwanchuan
		 */
		tabClass:function(args){
			var param = $.extend({node:'li', defaultClass:'current'}, args),
				elem = $(this).find(param.node).length ? $(this).find(param.node) : $ (this),
				defaultClass = param.defaultClass,
				defaultShow = param.defaultShow;
				
			if(defaultShow){
				elem.eq(defaultShow).addClass(defaultClass);
			}
			
			elem.bind({
				mouseenter:function(){
					$(this).addClass(defaultClass).siblings().removeClass(defaultClass);
				},
				mouseleave:function(){
					$(this).removeClass(defaultClass);
				}
			});
		},
		/*
		 * @function：切换：鼠标移动到不同的tab，切换相对应的内容
		 * @description：主要应用在商品分类推荐模块中，点击不同的标题，切换相对应的内容。
		 * @param：如{tabNode:'.jSortTab span', tabContent:'.jSortContent ul', arrow:'.jSortTabArrow', defaultClass:'current, setUpWidth:0}。setUpWidth值：0，1；其中0表示平均分配宽度，1表示默认宽度；
		 * @author：20130114 by bjwanchuan
		 */
		tab:function(args){
			var param = $.extend({tabNode:'.jSortTab span', arrow:'.jSortTabArrow', defaultClass:'current', tabContent:'.jSortContent ul'}, args),
				_this = this,
				tabNode = $(_this).find(param.tabNode),
				tabContent = $(_this).find(param.tabContent),
				arrow = $(_this).find(param.arrow);
				
			//初始化结构
			tabNode.eq(0).addClass(param.defaultClass);
			tabContent.eq(0).addClass(param.defaultClass);
			tabNode.each(function(i,n){
				$(n).attr('data-num',i);
			});
			
			var width = 0;
			//自适应宽度
			if(param.setUpWidth) {
				if(tabNode.width() > 0) {
					width = tabNode.width();
				}else{
					width = (tabNode.parent().parent().width()-0.03)/tabNode.length;	
				}
			}else{
				width = (tabNode.parent().parent().width()-0.03)/tabNode.length;
			}
			tabNode.css({width: width});
			arrow.css({width: width});
			
			//绑定鼠标移动事件
			tabNode.bind({
				mouseenter: function(){
					$(this).addClass(param.defaultClass).siblings().removeClass(param.defaultClass);
					tabContent.eq($(this).attr('data-num')).addClass(param.defaultClass).siblings().removeClass(param.defaultClass);
					arrow.animate({left:($(this).attr('data-num'))*width},300,function(){});
				}
			});
		},
		/*
		 * @function：切换显示：通过触发一个元素，切换其他元素的显示。可选择闭环切换、前进后退及随机切换显示。
		 * @description：可应用于任意模块，只要有使用场景。
		 * @param：如{eventNode:'.jClick', parentNode:'.jSortContent', childNode:'ul', defaultClass:'current', eventType:'click', num:0, tabTime:500, subFunction:'circle'}
		 * eventNode触发切换的节点；parent切换节点的父节点；child切换节点；defaultClass显示样式；eventType触发的事件类型；
		 * num初始显示第几个；tabTime每一屏切换的时间；subFunction显示方式：闭环circle、前进倒退direction、随机random；
		 * @author：20140117 by bjwanchuan
		 */
		tabShow : function(args){
			var param = $.extend({eventNode:'.jClick', parentNode:'.jSortContent', childNode:'ul', defaultClass:'current', eventType:'click', num:0, tabTime:500, subFunction:'circle'},args),
				_this = $(this),
				eventNode = _this.find(param.eventNode),//触发切换的节点
				parent = _this.find(param.parentNode),//切换节点的父节点
				child = _this.find(param.childNode),//切换节点
				defaultClass = param.defaultClass,//显示样式
				eventType = param.eventType,//触发的事件类型
				num = (param.num === Number && param.num <= len) ? param.num : 0,//初始显示第几个
				tabTime = param.tabTime,//每一屏切换的时间
				subFunction = param.subFunction,//显示方式：闭环circle、前进倒退direction、随机random
				len = child.length,
				isLeft = true;
				
			//初始化显示
			child.eq(num).addClass(defaultClass);
			
			//事件触发
			eventNode[eventType](function(){
				if(param.subFunction){
					showStyle[param.subFunction].call(_this);
				}
				callBack();
			});
			
			var showStyle = {
				circle : function(){
					num = (num + 1)%len;
				},
				direction : function(){
					if(isLeft){
						num++;
						if(num == len - 1){
							isLeft = false;
						}
					}else{
						num--;
						if(num  == 0){
							isLeft = true;
						}
					}	
				},
				random : function(){
					num = parseInt(Math.random() * len);
				}
			}
			
			function callBack(){
				child.eq(num).addClass(defaultClass).siblings().removeClass(defaultClass);
				child.animate({opacity:0},0,function(){});
				child.eq(num).animate({opacity:1},param.tabTime,function(){});	
			}
		},
		/*
		 * @function：自适应布局：根据布局的宽度判断能放下的一行数量，并将平均宽度转化为百分比形式。转化好的class类将自动写入节点。
		 * @description：主要应用于不同的宽度布局，如190、390、590、790、990等布局，同一套模板显示的列表个数会根据布局宽度自动计算，并撑满布局。这个方法和autoWidth类似，各有各的使用效果。
		 * @param：如{node:'li', spacingType:'margin', size:1}。node为需要计算宽度的节点；spacingType为节点的间距类型，其值为：margin和padding；size为间距的宽度，其值为0.5和1，其中0.5代表左右间距为0.5%，1代表左右间距为1%。
		 * @author：20130114 by bjwanchuan
		 */
		autoLayout : function(args){
			var _para = $.extend({node: 'li', spacingType: 'margin', size: 1},args || {}),
				_this = $(this),
				_elem = _this.find(_para.node),
				_qty = parseInt(_elem.parent().parent().width()/_elem.outerWidth(true)),
				_ie = $.browser.msie&&parseInt($.browser.version) <= 7?'i':'',
				_spacing = _para.spacingType.match(/^m/)?'m':'p',
				_size = _para.size == 0.5?'OneHalf':'One',
				_arr = ['qOne','qTwo','qThree','qFour','qFive','qSix','qSeven','qEight','qNine','qTen','qEleven','qTwelve'];
			
			_elem.addClass(_ie + _arr[_qty-1] + _size).addClass(_spacing + _size);
		},
		/*
		 * @function：自适应宽度：根据布局的宽度判断能放下的一行数量，并将多余的宽度平均分配给每一个列表项。支持css对象传入。
		 * @description：主要应用于不同的宽度布局，如190、390、590、790、990等布局，同一套模板显示的列表个数会根据布局宽度自动计算，并撑满布局。
		 * @param：如{node:'li', extra:{margin:'0 5px', padding:'5px 0'}}。node为需要计算宽度的节点；extra为给需要计算宽度的节点增加一些css样式，这样可适应不同的效果需求。
		 * @author：20130114 by bjwanchuan
		 */
		autoWidth:function(args){
			var _para = $.extend({node:'li', extra:{}}, args || {}),
				_this = this,
				elems = $(_this).find(_para.node), 
				elem = elems.eq(0);
			
			elems.css(_para.extra);
			
			var outerWidth = parseInt(elem.data('outerWidth') || elem.outerWidth(true)),
				width = parseInt(elem.data('width') || elem.css('width')),
				qty = parseInt(elem.parent().parent().width()/outerWidth);
			
			elem.data({'outerWidth':outerWidth, 'width':width});
			
			var extraWidth = outerWidth - width;
			var newWidth = (elem.parent().parent().width()-extraWidth*qty-0.03)/qty;
			elems.css({width:newWidth});
		},
		/*
		 * @function：平均宽度：根据父节点宽度，平均分配子节点宽度。
		 * @description：主要应用于导航、商品分类推荐等模块中。避免因数量较少而容器右边出现空白的情况。
		 * @param：如{equallyNode:'.jSortTab span', equallyParentNode:null}。equallyNode需要平均父级宽度的节点；equallyParentNode为父级节点，如果此参数没传则默认为当前引用此方法的节点。
		 * @author：20130114 by bjwanchuan
		 */
		equallyWidth:function(args){
			var param = $.extend({equallyNode:'.jSortTab span', equallyParentNode:null}, args),
				_this = $(this),
				nodeParent = (_this.find(param.equallyParentNode).length > 0) ? _this.find(param.equallyParentNode) : _this,
				elems = _this.find(param.equallyNode),
				elem = elems.eq(0);
			
			var outerWidth = parseInt(elem.data('outerWidth') || elem.outerWidth(true)),
				width = parseInt(elem.data('width') || elem.css('width')),
				qty = elems.length;
			
			elem.data({'outerWidth':outerWidth, 'width':width});
			
			var extraWidth = outerWidth - width;
			var newWidth = (nodeParent.width()-extraWidth*qty-0.03)/qty;
			elems.css({width:newWidth});
		},
		/*
		 * @function：100%高度：用在相对定位里面有绝对定位时，背景透明图层以父节点为基准将高度撑满。
		 * @description：主要应用于不同尺寸图片需要遮罩的效果中，由于高度100%存在浏览器兼容，这个方法会自动获取传入的基准容器高度，并赋给遮罩层。
		 * @param：如{fullHeightNode:'li', fullNode:'.jShade'}。fullHeightNode需要参照高度的基准节点；fullNode需要撑满高度的遮罩节点。
		 * @author：20130114 by bjwanchuan
		 */
		fullHeight:function(args){
			var param = $.extend({fullHeightNode:'li', fullNode:'.jShade'}, args),
				elem = $(this).find(param.fullHeightNode),
				fullNode;
			
			elem.bind({
				mouseenter:function(){
					fullNode =$(this).find(param.fullNode);
					fullNode.css({height:$(this).height()});
					
				}
			});
		},
		
		/*
		 * @function：关注品牌
		 * @author：2015-5-26 by 卢兴元
		 */
		followPinpai: function (args) {

			var param = $.extend({
					type : "shop",										//当前页面类型："shop"代表店铺，"act"代表活动。如果类型为"shop"，则idNodeSelector必须为店铺id，如果为"act"，则idNodeSelector必须为活动id
					clickNodeSelector : '.j-pinpai-attention', 		//点击触发关注店铺的节点选择器
					idNodeSelector: '.j-pinpai-id'					//存放（店铺/活动）id的节点选择器。该节点必须是存在于改模块内。并且该节点上必须有pinpaiId属性，属性值为（店铺/活动）id
				}, args || {}),
				jTarget = $(this),
				jClickNode = jTarget.find(param.clickNodeSelector),
				isSending = false;

			var ATTENT_INFO = {
				mall : {
					msgOk : '品牌关注成功',
					msgRepeat : '您已经关注过该品牌了',
					msgError : '品牌关注失败',
					msgOverMax : '已达到关注品牌数量上限',
					msgOther : '查看我关注的<a href="http://t.jd.com/follow/brand/list.action" target="_blank">品牌</a>'
				}
			};

			//方法工具类
			var tool = {

				//植入关注品牌功能，只适用于店铺
				followPinpai: function () {
					var pinpaiId = jTarget.find(param.idNodeSelector).attr("pinpaiId"),
						setting = {
							"shop": "shopId",
							"act": "activityId"
						},
						data = {};
					data[setting[param.type]] = pinpaiId;
					$.ajax({
						url: "http://follow.soa.jd.com/rpc/brand/batchfollow",
						data : {brandId : JSON.stringify([data]), sysName : 'mall.jd.com'},
						//url : INTERFACE.batchfollow + JSON.stringify([{shopId: 43858}]),
						dataType: 'jsonp',
						success: function (data) {
							if (data.code == 'F10000') {	//关注成功
								tool.resultHandle(1);
							}else if (data.code == 'F0402') {	//已经关注了
								tool.resultHandle(2);
							}else if( data.code == 'F0410' ) {	//关注达到最大数量，不能加关注
								tool.resultHandle(4);
							}else {								//关注失败
								tool.resultHandle(3);
							}
						}
					});
				},

				//处理关注响应结果
				//临时状态state ：0未关注；1关注成功；2已经关注；3关注失败；4关注达到上限
				resultHandle: function (state) {

					var jAttWrap = $(".j-attent-dialog-wrap"),
						mask = jAttWrap.find('.attent-dialog-mask'),
						con = jAttWrap.find('.attent-con'),
						msg = jAttWrap.find('.attent-msg'),
						other = jAttWrap.find('.attent-other'),
						close = jAttWrap.find('.attent-close');

					//关注成功
					if (state == 1) {
						msg.html(ATTENT_INFO.mall.msgOk);
						other.html(ATTENT_INFO.mall.msgOther);
						con.addClass('attent-ok');
					}
					//已经关注
					else if (state == 2) {
						msg.html(ATTENT_INFO.mall.msgRepeat);
						other.html(ATTENT_INFO.mall.msgOther);
						con.addClass('attent-repeat');
					}
					//关注失败
					else if (state == 3) {
						msg.html(ATTENT_INFO.mall.msgError);
						other.html(ATTENT_INFO.mall.msgOther);
						con.addClass('attent-error');
					}
					//达到关注数量上限
					else if (state == 4) {
						msg.html(ATTENT_INFO.mall.msgOverMax);
						other.html(ATTENT_INFO.mall.msgOther);
						con.addClass('attent-error');
					}
					jAttWrap.show();
					isSending = false;
				}
			};
			
			//模块方法初始化
			!function init(){
				cssInit();
				domInit();
				bindEvent();
			}();
			
			//绑定相关事件处理函数
			function bindEvent(){
				jClickNode.bind("click", function(){
					if(isSending === false){
						isSending = true;
						jdModelCallCenter.settings.fn = function() {
							tool.followPinpai();
						};
						$.login({
							modal: true,
							complete: function(result) {
								if (result != null && result.IsAuthenticated != null && result.IsAuthenticated) {
									jdModelCallCenter.settings.fn();//已经登陆后。增加关注
								}
							}
						});
					}
				});
				var jAttWrap = $(".j-attent-dialog-wrap");
				jAttWrap.find('.attent-close').click(function(){
					jAttWrap.hide();
				});
			}

			//CSS初始化
			function cssInit(){

				if(window.hasAddFollowCss){
					return;
				}else{
					window.hasAddFollowCss = true;
				}

				var styleStr = "<style>"
						+".j-attent-dialog-wrap{display: none;}"
						+".attent-tip-wrap{display: none; z-index: 1001; position: absolute; top: 0; left: 0; width: 189px; height: 131px; background: url(http://img11.360buyimg.com/cms/jfs/t904/96/974597196/7702/c65fa11b/5562e781N10be5ec3.png) no-repeat;}"
						+".attent-tip-wrap i{position: absolute; right: 5px; top: 9px; width: 15px; height: 15px; background: url(http://img14.360buyimg.com/cms/jfs/t1087/118/953149406/1062/b1c27ba1/5562e785Ndd770a39.png) no-repeat; cursor: pointer;}"
						+".attent-dialog-mask{position: fixed; _positon: absolute; left:0; top:0; right:0; bottom:0; background:#000; opacity:0.3; z-index:100;}"
						+".attent-dialog{position: fixed; _positon: absolute; width:310px; height:185px; border:solid 5px rgba(8,1,3,0.3); background:#fff; left:50%; top:50%; margin:-92px 0 0 -155px; z-index:1001;}"
						+".attent-dialog.current{display:block;}"
						+".attent-dialog .attent-mt{height:32px; line-height:32px; background:#f5f5f5; font-size:16px; color:#222; text-indent:10px; overflow:hidden;}"
						+".attent-dialog .attent-close{float:right; width:32px; height:32px; text-indent:-9999px; background:url(http://img10.360buyimg.com/cms/jfs/t1420/84/156758085/1080/d48a39fe/555e9e79N85386290.png) center center no-repeat; cursor:pointer;}"
						+".attent-dialog .attent-ok, .attent-dialog .attent-repeat, .attent-dialog .attent-error{margin:48px 0 0 55px; height:40px; padding-left:48px;}"
						+".attent-dialog .attent-ok{background:url(http://img12.360buyimg.com/cms/jfs/t1435/352/153421548/1347/d377c92d/555e9e71Nb767e906.png) left center no-repeat;}"
						+".attent-dialog .attent-repeat, .attent-dialog .attent-error{background:url(http://img14.360buyimg.com/cms/jfs/t1516/358/164942511/1418/e0c25f0c/555e9e75Nfca9da16.png) left center no-repeat;}"
						+".attent-dialog .attent-ok .attent-msg{font-size:14px; color:#009900; font-weight:bold;}"
						+".attent-dialog .attent-repeat .attent-msg, .attent-dialog .attent-error .attent-msg{font-size:14px; color:#ff771e; font-weight:bold;}"
						+".attent-dialog .attent-other{color:#6f6363; display:block; margin-top:3px;}"
						+".attent-dialog .attent-other a{color:#004499; padding: 0 5px;}"
						+".attent-dialog.attent-mall .attent-other a{margin:0 5px;}"
					+"</style>";
				$("head").append(styleStr);
			}

			//dom节点初始化
			function domInit(){

				if($(".j-attent-dialog-wrap").length) return;

				var	attentHtml = '<div class="j-attent-dialog-wrap">'
					+'<div class="attent-dialog-mask"></div>'
					+'<div class="attent-dialog">'
					+	'<div class="attent-mt">'
					+		'<span class="attent-close"  title="关闭">关闭</span>'
					+		'<span class="attent-title">提示</span>'
					+	'</div>'
					+	'<div class="attent-mc">'
					+		'<div class="attent-con">'
					+			'<span class="attent-msg"></span>'
					+			'<span class="attent-other"></span>'
					+		'</div>'
					+	'</div>'
					+'</div>'
					+'</div><div class="j-attent-tip-wrap attent-tip-wrap"><i></i></div>';
				$(attentHtml).appendTo("body");
			}
		},
		/* 
		 * @function 图片轮播：1、根据用户设置的宽度和高度来确定轮播图的大小。2、可自定义向左、向上轮播和渐变轮播参数。3、可设置图片轮播时间。
		 * @description 主要应用于图片轮播模块。
		 * @param：
		 * @author 20130114 by bjwanchuan
		 */
		slidePhoto:function(args){
			
			// 定义传入的CSS调用变量
			var _this=this,
				param=$.extend({imgArea:'.jbannerImg', imgNodeArea:'.jImgNodeArea', imgNode:'.jbannerImg dl', tabArea:'.jbannerTab', tabNode:'.jbannerTab span', photoName:'.jDesc', arrowLeft:'.jPreOut', arrowRight:'.jNextOut', arrowLeftOver:'jPreOver', arrowRightOver:'jNextOver', defaultClass:'show', slideDirection:'left', timer:'3', subFunction:'transparentEffect', eventType:'click',showArrow:1}, args),
				imgArea = $(_this).find(param.imgArea),
				imgNode = $(_this).find(param.imgNode),
				tabArea = $(_this).find(param.tabArea),
				tabNode = $(_this).find(param.tabNode),
				photoName = $(_this).find(param.photoName),
				defaultClass = param.defaultClass,
				eventType = param.eventType,
				timer = !param.timer*1000?3000:param.timer*1000,
				scroll,
				imgNodeArea = $(_this).find(param.imgNodeArea),
				isFull = param.isFull;
			
			//全局变量
			var index = 0,direction = 1,time = null,moveRange = 0,partTime = null,animate = null;
			if(!imgNode.length) return;
			
			/**
			 * 轮播图所有效果
			 */
			var banner = {
				transparentEffect : function(){
					//初始化
					$(_this).css({'background-color':imgNode.eq(index).attr('background')});
					
					// 调用函数
					init();
					triggerThumbnail();
					triggerDirection();
					if(param.showArrow!=1){triggerArrow();}
					animate = transparent;
					time = setTimeout(imgMove, timer);
				},
				moveEffect : function(){
					var isTop = (param.slideDirection == 'top')?true:false;
					scroll = (isTop)?"scrollTop":"scrollLeft";
					
					//初始化
					$(_this).css({'background-color':imgNode.eq(index).attr('background')});
					if(isTop){
						imgNodeArea.css({height:20000, width:$(_this).width()});
						imgNode.css({width:imgNodeArea.width(),height:"auto","float":"none"});
						moveRange = imgNode.height();
						imgArea[0][scroll] = index * moveRange;
					}else{
						imgNodeArea.css({width:20000});
						imgNode.css({width:imgNode.find("img").width(),height:"100%","float":"left"});//将这个宽度写在css里，在ie6下面，获取到的父级宽度是被这个元素撑开的宽度
						moveRange = imgNode.width();
						imgArea[0][scroll] = index * moveRange;
					};
					
					// 调用函数
					init();
					triggerThumbnail();
					triggerDirection();	
					if(param.showArrow!=1){triggerArrow();}
					animate = oneImgMove;
					time = setTimeout(imgMove, timer);
				}
			};
			
			/**
			 * 根据传入的子方法名执行对应的子方法
			 */
			if(banner[param.subFunction])
				banner[param.subFunction].call(_this);
			
			/**
			 * 轮播图初始化
			 */
			function init(){
				$(_this).css({cursor:'pointer'});
				imgArea.css({width:imgNode.find("img").width(),height:imgNode.find("img").height()});
				imgNode.eq(0).addClass(defaultClass);
				tabNode.eq(0).addClass(defaultClass);
				photoName.text(imgNode.eq(0).find("img").attr("title"));

				$(_this).click(function(){
					window.open(imgNode.eq(index).attr('ref'));
				});
				
				autoMiddle();
				$(window).resize(function(){
					autoMiddle();
				});
			}
			
			/**
			 * 轮播图自适应居中于屏幕中间
			 */
			function autoMiddle(){
				var extra = imgArea.width()-$(_this).width();
				if(extra>0){
					imgArea.css({'margin-left':-extra/2});
				}else{
					imgArea.css('margin','0 auto');
				}
			}
			
			/**
			 * 给每个tab缩略图绑定事件
			 */ 
			function triggerThumbnail(){
				tabNode.each(function(i,elem){
					$(elem)[eventType](function(){
						imgNode.eq(index).removeClass(defaultClass);
						tabNode.eq(index).removeClass(defaultClass);
						index = i;
						imgNode.eq(index).addClass(defaultClass);
						tabNode.eq(index).addClass(defaultClass);
						photoName.text(imgNode.eq(index).find("img").attr("title"));
						animate();
						return false;
					});
				});
			}
			
			/**
			 * 点击箭头或数字时，重置时间
			 */
			function _stop(){
				clearTimeout(time);
				time = null;
				clearTimeout(partTime);
				partTime = null;
				imgNodeArea.clearQueue();
				imgNode.eq(index).clearQueue();
			}
			
			/**
			 * 切换图片和缩略图
			 */ 
			function imgMove(){
				if (direction == 1){
					if (index < imgNode.length - 1){
						classOper([imgNode,tabNode],defaultClass,true);
					}else{
						direction = 0;
						classOper([imgNode,tabNode],defaultClass,false);
					}
				}else{
					if (index > 0){
						classOper([imgNode,tabNode],defaultClass,false);
					}else{
						direction = 1;
						classOper([imgNode,tabNode],defaultClass,true);
					}
				}
				photoName.text(imgNode.eq(index).find("img").attr("title"));
				animate();
			}
			
			/**
			 * 鼠标移动显示左右移动箭头
			 */
			function triggerArrow(){
				var arrowLeft = $(_this).find(param.arrowLeft),arrowRight = $(_this).find(param.arrowRight);
				$(_this).bind({
					mouseover:function(){
						arrowLeft.show();
						arrowRight.show();
					},
					mouseout:function(){
						arrowLeft.hide();
						arrowRight.hide();
					}
				 });
			}
			
			/**
			 * 处理左右移动箭头
			 */
			function triggerDirection(){
				var arrowLeft = $(_this).find(param.arrowLeft),arrowRight = $(_this).find(param.arrowRight),
					arrowLeftOver = param.arrowLeftOver, arrowRightOver = param.arrowRightOver;
				
				arrowLeft.bind({
					click:function(){
						if(index != 0){// 判断当前是不是第一张
							classOper([imgNode,tabNode],defaultClass,false);
							animate();
						}
						return false;
					},
					mouseover:function(){$(this).addClass(arrowLeftOver);},
					mouseout:function(){$(this).removeClass(arrowLeftOver);}
				});
				arrowRight.bind({
					click:function(){
						if(index < imgNode.length - 1){// 判断当前是不是最后一张
							classOper([imgNode,tabNode],defaultClass,true);
							animate();
						}
						return false;
					},
					mouseover:function(){$(this).addClass(arrowRightOver);},
					mouseout:function(){$(this).removeClass(arrowRightOver);}
				});
			}
			
			/**
			 * 透明效果
			 */
			function transparent(){
				imgNode.animate({
					opacity: 0
				  }, 0, function() {
				  });
				$(_this).css({'background-color':imgNode.eq(index).attr('background')});
				imgNode.eq(index).animate({
					opacity: 1
				  }, 1000, function() {
					  _stop();
					  time = setTimeout(imgMove, timer);
				  });
			}
			
			/** 
			 * 移动效果：每一张图片分10次移动
			 */
			function oneImgMove(){
				var nowMoveRange = (index * moveRange) - imgArea[0][scroll],
				partImgRange = nowMoveRange > 0 ? Math.ceil(nowMoveRange / 10) : Math.floor(nowMoveRange / 10);
				imgArea[0][scroll] += partImgRange;
				if (partImgRange == 0){
					imgNode.eq(index).addClass(defaultClass);
					tabNode.eq(index).addClass(defaultClass);
					photoName.text(imgNode.eq(index).find("img").attr("title"));
					partImgRange = null;
					_stop();
					time = setTimeout(imgMove, timer);
				}
				else{
					partTime = setTimeout(oneImgMove,30);	
				}
				$(_this).css({'background-color':imgNode.eq(index).attr('background')});
			}

			/**
			 * 节点css类名操作
			 */ 
			function classOper(arr,className,flag){
				arr.each(function(ind,n){
					n.eq(index).removeClass(className);
				})
				flag?(index++):(index--);
				arr.each(function(ind,n){
					n.eq(index).addClass(className);
				});
			}
		},
		/* 
		 * @function 片段轮播：1、根据用户设置的宽度和高度来确定轮播图的大小。2、可自定义向左、向上轮播和渐变轮播参数。3、可设置轮播时间。
		 * @description 主要应用于html片段轮播，即雷宁轮播模块。此模块和图片轮播功能类似，差异之处在于图片轮播的数据是用户自己上传的图片，html片段轮播每一屏都是一个自定义编辑器，里面的内容全部由用户自定义。
		 * @param：
		 * @author 20130114 by bjwanchuan
		 */
		slideHtml:function(args){
			
			// 定义传入的CSS调用变量
			var _this=this,
				param=$.extend({imgArea:'.jbannerImg', imgNodeArea:'.jImgNodeArea', imgNode:'.jbannerImg li', tabArea:'.jbannerTab', tabNode:'.jbannerTab span', arrowLeft:'.jPreOut', arrowRight:'.jNextOut', arrowLeftOver:'jPreOver', arrowRightOver:'jNextOver', defaultClass:'show', slideDirection:'left', timer:'3', subFunction:'transparentEffect', eventType:'click',showArrow:1}, args),
				imgArea = $(_this).find(param.imgArea),
				imgNode = $(_this).find(param.imgNode),
				tabArea = $(_this).find(param.tabArea),
				tabNode = $(_this).find(param.tabNode),
				photoName = $(_this).find(param.photoName),
				defaultClass = param.defaultClass,
				eventType = param.eventType,
				timer = !param.timer*1000?3000:param.timer*1000,
				scroll,
				ul = $(_this).find(param.imgNodeArea + '>ul'),
				imgNodeArea = $(_this).find(param.imgNodeArea),
				isFull = param.isFull;

			//全局变量
			var index = 0,direction = 1,time = null,moveRange = 0,partTime = null,animate = null;
			if(!imgNode.length) return;
			
			/**
			 * 轮播图所有效果
			 */
			var banner = {
				transparentEffect : function(){
					//初始化
					$(_this).css({'background-color':imgNode.eq(index).attr('background')});
					
					// 调用函数
					init();
					triggerThumbnail();
					triggerDirection();
					if(param.showArrow!=1){triggerArrow();}
					animate = transparent;
					time = setTimeout(imgMove, timer);
				},
				moveEffect : function(){
					var isTop = (param.slideDirection == 'top')?true:false;
					scroll = (isTop)?"scrollTop":"scrollLeft";
					
					//初始化
					$(_this).css({'background-color':imgNode.eq(index).attr('background')});
					if(isTop){
						imgNodeArea.css({height:20000});
						imgNode.css({width:imgNode.attr("width"),height:imgNode.attr("height")});
						moveRange = imgNode.height();
						imgArea[0][scroll] = index * moveRange;
					}else{
						imgNodeArea.css({width:20000});
						imgNode.css({width:imgNode.attr("width"),height:imgNode.attr("height"),'float':"left"});//将这个宽度写在css里，在ie6下面，获取到的父级宽度是被这个元素撑开的宽度
						moveRange = imgNode.width();
						imgArea[0][scroll] = index * moveRange;
					};
					
					// 调用函数
					init();
					triggerThumbnail();
					triggerDirection();	
					if(param.showArrow!=1){triggerArrow();}
					animate = oneImgMove;
					time = setTimeout(imgMove, timer);
				}
			};
			
			/**
			 * 根据传入的子方法名执行对应的子方法
			 */
			if(banner[param.subFunction])
				banner[param.subFunction].call(_this);
			
			/**
			 * 轮播图初始化
			 */
			function init(){
				imgArea.css({width:imgNode.attr("width"),height:imgNode.attr("height")});
				imgNode.eq(0).addClass(defaultClass);
				tabNode.eq(0).addClass(defaultClass);
				autoMiddle();
				$(window).resize(function(){
					autoMiddle();
				});
			}
			
			/**
			 * 轮播图自适应居中于屏幕中间
			 */
			function autoMiddle(){
				var extra = imgArea.width()-$(_this).width();
				if(extra>0){
					imgArea.css({'margin-left':-extra/2});
				}else{
					imgArea.css('margin','0 auto');
				}
			}
			
			/**
			 * 给每个tab缩略图绑定事件
			 */ 
			function triggerThumbnail(){
				tabNode.each(function(i,elem){
					$(elem)[eventType](function(){			   
						imgNode.eq(index).removeClass(defaultClass);
						tabNode.eq(index).removeClass(defaultClass);
						index = i;
						imgNode.eq(index).addClass(defaultClass);
						tabNode.eq(index).addClass(defaultClass);
						animate();
						return false;
					});
				});
			}
			
			/**
			 * 点击箭头或数字时，重置时间
			 */
			function _stop(){
				clearTimeout(time);
				time = null;
				clearTimeout(partTime);
				partTime = null;
				ul.clearQueue();
				imgNode.eq(index).clearQueue();
			}
			
			/**
			 * 切换图片和缩略图
			 */ 
			function imgMove(){
				if (direction == 1){
					if (index < imgNode.length - 1){
						classOper([imgNode,tabNode],defaultClass,true);
					}else{
						direction = 0;
						classOper([imgNode,tabNode],defaultClass,false);
					}
				}else{
					if (index > 0){
						classOper([imgNode,tabNode],defaultClass,false);
					}else{
						direction = 1;
						classOper([imgNode,tabNode],defaultClass,true);
					}
				}
				animate();
			}
			
			/**
			 * 鼠标移动显示左右移动箭头
			 */
			function triggerArrow(){
				var arrowLeft = $(_this).find(param.arrowLeft),arrowRight = $(_this).find(param.arrowRight);
				$(_this).bind({
					mouseover:function(){
						arrowLeft.show();
						arrowRight.show();
					},
					mouseout:function(){
						arrowLeft.hide();
						arrowRight.hide();
					}
				 });
			}
			
			/**
			 * 处理左右移动箭头
			 */
			function triggerDirection(){
				var arrowLeft = $(_this).find(param.arrowLeft),arrowRight = $(_this).find(param.arrowRight),
					arrowLeftOver = param.arrowLeftOver, arrowRightOver = param.arrowRightOver;
				
				arrowLeft.bind({
					click:function(){
						if(index != 0){// 判断当前是不是第一张
							classOper([imgNode,tabNode],defaultClass,false);
							animate();
						}
						return false;
					},
					mouseover:function(){$(this).addClass(arrowLeftOver);},
					mouseout:function(){$(this).removeClass(arrowLeftOver);}
				});
				arrowRight.bind({
					click:function(){
						if(index < imgNode.length - 1){// 判断当前是不是最后一张
							classOper([imgNode,tabNode],defaultClass,true);
							animate();
						}
						return false;
					},
					mouseover:function(){$(this).addClass(arrowRightOver);},
					mouseout:function(){$(this).removeClass(arrowRightOver);}
				});
			}
			
			/**
			 * 透明效果
			 */
			function transparent(){
				imgNode.animate({
					opacity: 0
				  }, 0, function() {
				  });
				$(_this).css({'background-color':imgNode.eq(index).attr('background')});
				imgNode.eq(index).animate({
					opacity: 1
				  }, 1000, function() {
					  _stop();
					  time = setTimeout(imgMove, timer);
				  });
				
			}
			
			/** 
			 * 移动效果：每一张图片分10次移动
			 */
			function oneImgMove(){
				var nowMoveRange = (index * moveRange) - imgArea[0][scroll],
				partImgRange = nowMoveRange > 0 ? Math.ceil(nowMoveRange / 10) : Math.floor(nowMoveRange / 10);
				imgArea[0][scroll] += partImgRange;
				if (partImgRange == 0){
					imgNode.eq(index).addClass(defaultClass);
					tabNode.eq(index).addClass(defaultClass);
					partImgRange = null;
					_stop();
					time = setTimeout(imgMove, timer);
				}
				else{
					partTime = setTimeout(oneImgMove,30);	
				}
				$(_this).css({'background-color':imgNode.eq(index).attr('background')});
			}

			/**
			 * 节点css类名操作
			 */ 
			function classOper(arr,className,flag){
				arr.each(function(ind,n){
					n.eq(index).removeClass(className);
				})
				flag?(index++):(index--);
				arr.each(function(ind,n){
					n.eq(index).addClass(className);
				});
			}
		},
		/*
		 * @function：改变图片：事件触发小图查看大图。
		 * @description：主要应用于商品推荐、主从商品等模块，能取到同一张不同尺寸大小的图片，这样就可以实现事件触发小图查看大图的效果。
		 * @param：
		 * @author：20130114 by bjwanchuan
		 */
		changePhoto : function(args){
			var param = $.extend({changePhotoNode:'.jPic img' , smallPhoto:'.jScrollWrap li', title:'.jDesc a', defaultClass:'jCurrent', eventType:'click'} , args || {}),
				_this = $(this),
				largePhoto = _this.find(param.changePhotoNode),
				smallPhoto = _this.find(param.smallPhoto),
				title = _this.find(param.title);
			
			//初始化
			largePhoto.attr('src' , smallPhoto.eq(0).attr('data-src'));
			largePhoto.parent().attr('href' , smallPhoto.eq(0).attr('data-href'));
			title.attr('href' , smallPhoto.eq(0).attr('data-href'));
			
			smallPhoto.eq(0).addClass(param.defaultClass);
			
			//触发小图
			smallPhoto[param.eventType](function(){
				var _target = this;
				
				largePhoto.attr('src' , $(_target).attr('data-src'));
				largePhoto.parent().attr('href' , $(_target).attr('data-href'));
				title.attr('href' , $(_target).attr('data-href'));
				
				//切换大图的时候 同时切换关注商品的input 结点ID
				var goodsFollow = $(_target).parents("li.jSubObject");
				if( typeof goodsFollow != "undefined" && typeof $(_target).attr('sid') != "undefined" ){
					var btnColl = jQuery(goodsFollow).find(".btn-coll");
					if( typeof btnColl.attr('id') != "undefined" ){
						btnColl.attr('id',"coll"+ $(_target).attr('sid') );
					}	
				}
				
				$(_target).addClass(param.defaultClass).siblings().removeClass(param.defaultClass);
			});
		},
		/*
		 * @function：移动图片：点击左右箭头移动图片。
		 * @description：主要应用于主从商品等模块，当容器宽度有限，图片却很多时，点击左右箭头就可移动图片。
		 * @param：
		 * @author：20130114 by bjwanchuan
		 */
		movePhoto : function(args){
			var param = $.extend({movePhotoNode:'.jScrollWrap li' , arrowPrev:'.jScrollPrev', arrowNext:'.jScrollNext', defaultClass:'disabled'} , args || {}),
				_this = $(this),
				node = _this.find(param.movePhotoNode),
				prev = _this.find(param.arrowPrev),
				next = _this.find(param.arrowNext),
				visibleNode = parseInt(node.parent().parent().width()/node.width()),
				index = 0,
				length = node.length;
			
			//初始化结构
			if(length > visibleNode){
				prev.addClass(param.defaultClass).show();
				next.show();
				node.parent().css('width',node.width()*length);
			}
			
			//向右移动
			next.click(function(){
				var _this = this;
				
				if(length - visibleNode){
					prev.removeClass(param.defaultClass);
				}
				
				if(index < length - visibleNode){
					index++;
					node.parent().animate({
						left:-node.eq(0).outerWidth(true)*index
					},function(){
						if(index + visibleNode == length){
							$(_this).addClass(param.defaultClass);
						}
					});
				}
			});
			
			//向左移动
			prev.click(function(){	
				var _this = this;
				if(index  + visibleNode <= length){
					next.removeClass(param.defaultClass);
				}

				if(index > 0){
					index--;
					node.parent().animate({
						left:-node.eq(0).outerWidth(true)*index
					},function(){
						if(!index){
							$(_this).addClass(param.defaultClass);
						}
					});
				}
			});	
		},
		/*
		 * @function：操作节点：通过不同的条件，调用不同的方法，查找对象里面的某一个或一些节点，并对这些节点做操作，默认为增加一个样式。
		 * @description：可应用于任意模块，只要有使用场景。
		 * @param：如{operateNode:'li', operateParentNode:null, defaultClass:'jCurrent', length:0, subFunction:null, number:[], callBack:null}
		 * operateNode为需要查找的节点；operateParentNode为查找节点的父级节点；defaultClass为默认样式名；length为每一行的节点个数；subFunction为此方法里面的子方法；
		 * number为数组对象，当使用getNode方法时，表示数组里面指定的节点，当使用getColumn方法时，表示指定的列节点。当使用getRow方法时，表示指定的行节点；
		 * callBack为函数体，参数接收一个节点对象，可在函数体里对接收的这个对象做操作。
		 * @author：20130114 by bjwanchuan
		 */
		operateNode: function(args){
			var param = $.extend({operateNode:'li', operateParentNode:null, defaultClass:'jCurrent', length:0, subFunction:null, number:[], callBack:null},args||{}),
			_this = $(this),
			node = _this.find(param.operateNode),
			nodeParent = (_this.find(param.operateParentNode).length > 0) ? _this.find(param.operateParentNode) : _this.parent().parent().parent(),
			defaultClass = param.defaultClass,
			number = param.number,
			length = (param.length != 0) ? param.length : parseInt(nodeParent.outerWidth(true)/node.outerWidth(true)),
			callBack = typeof(param.callBack) === 'function' ? param.callBack : function(a){a.addClass(defaultClass);};
		
			if(node.length === 0) return;
			
			//ie9下获取nodeParent.outerWidth(true)有差异。为避免此问题，1、可传入明确知道宽度的节点；2、程序会取this的父级的父级的父级定义了宽度的层。
			//此段尚未使用，当元素隐藏后获取不到元素的偏移值
			var rowLen = 0;
			var nowTop = $(node[0]).offset().top;
			node.each(function(index, dom){
				if(index > 0){
					rowLen++;
					var _top = $(dom).offset().top;
					if(nowTop !== _top){
						return false;
					}else{
						nowTop = _top;
					}
				}
			});
			
			var operate = {
				//获取任意节点
				getNode : function(){
					return node.map(function(i,e){
						for(var j = 0; j < number.length; j++){
							if(i + 1 === number[j]){
								return e;
							}
						}
					});
				},
				//获取所有奇数列节点
				getAllOdd : function (){
					return node.map(function(i, e){
						if(i % 2 === 0){
							return e;
						}
					})
				},
				//获取所有偶数列节点
				getAllEven : function(){
					return node.map(function(i,e){
						if(i % 2 === 1){
							return e;
						}
					});
				},
				//获取任意多列节点
				getColumn : function(){
					return node.map(function(i,e){
						for(var j = 0; j < number.length; j++){
							if(i % length === number[j] - 1){
								return e;
							}
						}
					});
				},
				//获取任意多行节点
				getRow : function(){
					return node.map(function(i,e){
						for(var j = 0; j < number.length; j++){
							if(i >= length * (number[j] - 1) && i < length * number[j]){
								return e;
							}
						}
					});
				},
				//获取每一行的奇数节点
				getRowOdd : function(){
					return node.map(function(i,e){
						if(i % length % 2 === 0){
							return e;
						}
					});
				},
				//获取每一行的偶数节点
				getRowEven : function(){
					return node.map(function(i,e){
						if(i % length % 2 === 1){
							return e;
						}
					});
				},
				//获取第一个节点
				getFirst : function(){
					return node.eq(0);
				},
				//获取最后一个节点
				getLast : function(){
					return node.eq(node.length - 1);
				},
				//获取每一行的第一个节点
				getRowFirst : function(){
					return node.map(function(i,e){
						if(i % length === 0){
							return e;
						}
					});
				},
				//获取每一行的最后一个节点
				getRowLast : function(){
					return node.map(function(i,e){
						if(i % length === length - 1){
							return e;
						}
					});
				},
				//获取每一行的第一个节点和最后一个节点
				getRowFirstAndLast : function(){
					return node.map(function(i,e){
						if(i % length === 0 || i % length === length - 1){
							return e;
						}
					});
				}
			}
			
			if(operate[param.subFunction]){
				callBack(operate[param.subFunction]());
			}
		},
		/*
		 * @function： 移动节点
		 * @description：点击左右箭头移动节点，可移动单个节点，也可移动一屏节点，可左右移动，也可左右循环移动
		 * @param：moveNode需要移动的节点；arrowPrev左箭头；arrowNext右箭头；disabled箭头不可用样式；showNum一屏显示数量，可传入正确的一屏数量，没传则程序计算；
					cssValue改变的css属性名；isLoop是否循环，默认为真；isScreen是否是移动一屏，默认为真；timer每一次移动的时间，默认为1，值取0-4之间。
		 * @note：如果是移动一屏，则需要的节点总数量必须为每一屏可显示的整数倍；如果是循环切换，disabled参数可不用。
		 * @author： cdwanchuan@jd.com 2014-03
		*/
		moveNode : function(args){
			var param = $.extend({moveNode:'.scroll-area li' , arrowPrev:'.arrow-left', arrowNext:'.arrow-right', disabled:'disabled', showNum:'', cssValue:'margin-left', isLoop:true, isScreen:true, timer:1} , args || {}),
				_this = $(this),
				node = _this.find(param.moveNode),
				prev = _this.find(param.arrowPrev),
				next = _this.find(param.arrowNext),
				showNum = (param.showNum> 0)? parseInt(param.showNum) : Math.ceil(node.parent().parent().width()/node.outerWidth(true)),
				index = 0,
				length = param.isScreen ? Math.ceil(node.length/showNum) : node.length,
				eventFlag = true,
				moveWidth = param.isScreen ? showNum*node.eq(0).outerWidth(true) : node.eq(0).outerWidth(true),
				visibleNum = param.isScreen ? 1 : showNum,
				timer = !(param.timer > -1 && param.timer < 5) ? 1000 : param.timer*1000;
			
			if(length > visibleNum){
				prev.show().addClass(param.disabled);
				next.show();
				node.parent().css('width',moveWidth*length*10);
				
				if(param.isLoop){initLoop();}
			}
			
			function initLoop(){
				for(var i=0; i<showNum; i++){
					node.eq(i).clone().appendTo(node.parent());
					node.eq(node.length-1-i).clone().prependTo(node.parent());
				}
				node.parent().css(param.cssValue,-moveWidth*visibleNum + parseInt(node.parent().css(param.cssValue)));	
			}
			
			var cssJson = {};
			node.parent().data('cssInitValue', parseInt(node.parent().css(param.cssValue)));
			
			next.click(function(){
				if(!param.isLoop){
					if(index == 0) eventFlag = true;
				}
				
				if(eventFlag){
					eventFlag = false;
					index++;
					cssJson[param.cssValue] = -moveWidth*index + node.parent().data('cssInitValue');
					
					node.parent().animate(cssJson, timer, function(){
						eventFlag = true;
						if(!param.isLoop){
							if(index > 0){
								prev.removeClass(param.disabled);
							}
							if(index+visibleNum == length){
								next.addClass(param.disabled);
								eventFlag = false;
							}
						}else{
							if(index == length){
								index = 0;
								node.parent().css(param.cssValue,node.parent().data('cssInitValue'));	
							}
						}
					});
				}
			});
			
			prev.click(function(){
				if(!param.isLoop){
					eventFlag = (index > 0) ? true :false;
				}
				
				if(eventFlag){
					eventFlag = false;
					index--;
					cssJson[param.cssValue] = -moveWidth*index + node.parent().data('cssInitValue');
					
					node.parent().animate(cssJson, timer, function(){
						eventFlag = true;
						if(!param.isLoop){
							if(index < length - 1){
								next.removeClass(param.disabled);
							}
							if(index == 0){
								prev.addClass(param.disabled);
								eventFlag = false;
							}
						}else{
							if(index < 0){
								index = length-1;
								node.parent().css(param.cssValue,node.parent().data('cssInitValue')+(-moveWidth*index));	
							}
						}
					});
				}
			});	
		},
		/*
		 * @function：多行省略号 ：计算文字的数量，超过一定的数量后，剩余的用其他传入的字符替换。
		 * @description：主要应用于商品展示类模块中，如商品推荐、分页显示商品、店内搜索结果、主从商品等等模块，当商品标题太长而布局容器有限时使用。
		 * @param：如{title:'.jDesc a', count:15, text:'...'}。title需要替换的文字节点；count文字的数量；text用于替换的字符；
		 * @author：20130114 by bjwanchuan
		 */
		addEllipsis:function(args){
		   var param = $.extend({title:'.jDesc a', count:15, text:'...'}, args),
		   		_this = $(this),
				elem = _this.find(param.title);
		   
			elem.each(function(index, ele){
				var textNode=ele.firstChild;
				if(textNode && textNode.nodeType==3 && textNode.length>=param.count){
					textNode.replaceData(param.count, textNode.length, param.text);
				}					   
			});
	   },
		shopSearch : function(args){
			jshop.module.search.shopSearch.call(this,args);
		},
		follow : (function(){
			    // 默认参数设置
			var _default = {
				// 关注店铺Api
				shopApi: "http://follow.soa.jd.com/vender/follow",
				// 关注活动Api
				actApi: "http://follow.soa.jd.com/activity/follow",
				// 已收藏店铺数量Api
				shopCountApi: "http://follow.soa.jd.com/vender/queryForCount",
				// 已收藏活动数量Api
				actCountApi: "http://follow.soa.jd.com/activity/queryForCount",
				// 关注商品Api
				goodsApi: "",
				// 默认关注类型（店铺）
				type: "shopId"
			};

			function newTagOnfocus() {
				var val = jQuery("#newTag").val();
				val = val.trim();
				if (val == jQuery("#newTag").attr("placeholder")) {
					jQuery("#newTag").val("");
				}
			}

			function checkLength(node) {
				if (node.value.length > 10) {
					node.value = node.value.substring(0, 10);
				}
			}


			function Follow(cfg,scope) {
				this.config = jQuery.extend({}, cfg);

				var config = jQuery.extend({}, this.config);
				this.container = $(config.node,scope);

				this.get = function(p) {
					return config[p];
				};
				this.set = function(p, v) {
					config[p] = v;
				};

				this.init();
			}

			Follow.FollowVMContent = '<div id="whole">'
									+ '<div id="followSuccessDiv">'
									+ '<div class="tips" id="success"> <h2>关注成功！</h2>'
									+ '<p><em id="followNum"></em>'
									+ '<a target="_blank" href="http://t.jd.com/vender/followVenderList.action">查看我的关注&gt;&gt;</a>'
									+ '</p></div>'
									+ '<div id="attention-tags"><div class="mt">'
									+ "<h4>选择标签<em>（最多可选3个）</em></h4>"
									+ '<div class="extra"></div></div>'
									+ '<div class="mc"><div id="followTags"></div>'
									+ '<div class="att-tag-btn">'
									+ '<a href="javascript:void(0);" class="att-btn-ok">确定</a>'
									+ '<a class="att-btn-cancal" href="javascript:jdThickBoxclose()">取消</a>'
									+ '<span id="follow_error_msg"  class="att-tips fl"></span></div></div>'
									+ '</div></div>'
									+ '<div id="followTopicSuccessDiv">'
									+ '<div id="att-mod-success">'
									+ '<div class="att-img fl"><img src="http://misc.360buyimg.com/201007/skin/df/i/icon_correct.jpg" alt=""></div>'
									+ '<div class="att-content"><h2>关注成功</h2>'
									+ '<p><em id="followTopicNum" ></em>'
									+ '<a target="_blank" href="http://t.jd.com/activity/followActivityList.action">查看我的关注 &gt;&gt;</a>'
									+ '</p></div>'
									+ '<div class="att-tag-btn">'
									+ '<a class="att-btn-cancal" href="javascript:jdThickBoxclose()" onclick="jdThickBoxclose()">关闭</a>'
									+ '</div></div></div>'
									+ '<div id="followFailDiv" >'
									+ '<div id="att-mod-again">'
									+ '<div class="att-img fl">'
									+ '<img src="http://misc.360buyimg.com/201007/skin/df/i/icon_sigh.jpg" alt="">'
									+ '</div><div class="att-content"><h2>关注失败</h2>'
									+ '<p><a id=\'followFailSeeFollowUrl\' target="_blank" href="http://t.jd.com/vender/followVenderList.action">查看我的关注 &gt;&gt;</a></p>'
									+ '</div><div class="att-tag-btn"><a class="att-btn-cancal" href="javascript:jdThickBoxclose()">关闭</a></div>'
									+ '</div></div><div id="followMaxDiv">'
									+ '<div id="att-mod-again">'
									+ '<div class="att-img fl">'
									+ '<img src="http://misc.360buyimg.com/201007/skin/df/i/icon_sigh.jpg" alt="">'
									+ '</div><div class="att-content">'
									+ '<h2>关注数量达到最大限制</h2>'
									+ '<p><a id=\'followMaxSeeFollowUrl\' target="_blank" href="http://t.jd.com/vender/followVenderList.action">查看我的关注 &gt;&gt;</a></p>'
									+ '</div><div class="att-tag-btn">'
									+ '<a class="att-btn-cancal" href="javascript:jdThickBoxclose()">关闭</a></div>'
									+ '</div></div><div id="followedDiv">'
									+ '<div id="att-mod-again"><div class="att-img fl">'
									+ '<img src="http://misc.360buyimg.com/201007/skin/df/i/icon_sigh.jpg" alt="">'
									+ '</div><div class="att-content">'
									+ '<h2 id="followedTitle"></h2>'
									+ '<p><em id="followedNum"></em>'
									+ '<a id=\'followedSeeFollowUrl\' target="_blank" href="">查看我的关注 &gt;&gt;</a>'
									+ '</p></div><div class="att-tag-btn">'
									+ '<a class="att-btn-cancal" href="javascript:jdThickBoxclose()">关闭</a></div></div>'
									+ '</div></div>';

			Follow.prototype = {
				init: function() {
					var _this = this;

					_this.bindEvent();

				},
				bindEvent: function() {
					var _this = this;

					_this.container.click(function(){
						thick_login(function(){
							_this.addFollow();
						});
					   
					});
					// 为确定按钮添加事件代理，删除dom中的onclick事件绑定
					jQuery("body").delegate(".att-btn-ok", "click", function(){
						_this.doSubmit();
					});
				},
				addFollow: function() {
					var _this = this, api;
					if (_this.get("type") == "shopId") {
						api = _this.get("shopApi");
						api += "?venderId=" + _this.get("id");
					} else {
						api = _this.get("actApi");
						api += "?activityId=" + _this.get("id");
						api += "&srcType=0";
					}

					// documentFragment
					Follow.followVM = jQuery(Follow.FollowVMContent);
					// 根据不同关注类型，发送关注请求
					jQuery.ajax({
						async: false,
						url: api,
						dataType: "jsonp",
						success: function(data) {
							_this.followSuccess(data);
						},
						error: function(data, xhr) {
							_this.followShopFail();
						}
					});
				},
				followSuccess: function(data) {
					this.checkResult(data, this.followSuccessCallBack, this.followed, this.followShopMax);
				},
				checkResult: function(data, callback, followed, max) {
					// 根据不同的关注状态，弹出不同的提示浮层
					switch(data.code) {
						case "F10000":
							callback && callback.call(this);
							break;
						case "F0409":
							followed && followed.call(this);
							break;
						case "F0410":
							max && max.call(this);
							break;
						default:
							this.followShopFail.call(this);
					}
				},
				// 关注成功
				followSuccessCallBack: function() {
					var _this = this, api, type = _this.get("type");
					if (type == "shopId") {
						api = _this.get("shopCountApi");
					} else {
						api = _this.get("actCountApi");
					}
					_this.getFollowNum(api, function(data) {
						if (data.code == "F10000") {
							var outStr;
							if (type == "shopId") {
								outStr = "您已关注" + data.data + "个店铺";
								Follow.followVM.find("#followNum").html(outStr);
							} else {
								outStr = "您已关注" + data.data + "个活动";
								Follow.followVM.find("#followTopicNum").html(outStr);
							}
						}
						if (type == "shopId") {
							_this.getFollowTags();
						} else {
							_this.ShowFollowTopicSuc();
						}
					});
				},
				// 获取关注数
				getFollowNum: function(url, cb) {
					var _this = this;
					jQuery.ajax({
						async: false,
						url: url,
						dataType: "jsonp",
						success: function(data) {
							cb && cb(data);
						},
						error: function(data, shr) {
							_this.followShopFail();
						}
					});
				},
				// 获取关注标签
				getFollowTags: function() {
					var _this = this;
					jQuery.ajax({
						async: false,
						url: "http://follow.soa.jd.com/vender/queryTagForListByCount?count=5",
						dataType: "jsonp",
						success: function(data) {
							_this.fillInTags(data);
							_this.ShowFollowSuc();
						},
						error: function(data, D) {
							_this.followShopFail();
						}
					});
				},
				// 写入添加关注标签的dom结构
				fillInTags: function(data) {
					var _this = this,
						obj = data,
						len = obj.data.length,
						dom = "";
					dom += "<ul id='oldTags' class='att-tag-list'>";
					var str;
					for (var i = 0; i < len; i++) {
						// var H = "att-tag" + i;
						str = obj.data[i];
						str = decodeURIComponent(str);
						dom += "<li><a href='javascript:void(0)' class='J_ChooseTagOne'>" + str + "</a></li>";
					}
					dom += "</ul>";
					dom += "<ul id='newTags' class='att-tag-list att-tag-list-save'>";
					dom += "<li id='att-tag-new' class='att-tag-new'><input id='newTag' type='text' placeholder='自定义' maxlength='10'><span id='J_SaveTagOneBtn'>添加</span></li>";
					dom += "</ul>";
					dom += "";
					Follow.followVM.find("#followTags").html(dom);
				},
				ShowFollowSuc: function() {
					var _this = this, title = "提示", node = jQuery("#dialogDiv");
					node.html('<a id="dialogA" href="#"></a>');
					$.jdThickBox({
						width: 510,
						height: 260,
						title: title,
						_box: "btn_coll_shop_pop",
						source: Follow.followVM.find("#followSuccessDiv").html()
					}, function() {
						var spop = jQuery("#btn_coll_shop_pop"),
							spop_mc = jQuery("#attention-tags").find(".mc");
						spop.find(".thickcon").css("height", "auto");
						spop.css("height", "auto");
						jQuery("#newTag").val(jQuery("#newTag").attr("placeholder"));

						// 绑定标签输入框focus、keyup事件，用于验证标签合法性，一处dom中的onxxx事件属性
						jQuery("#newTag").unbind("focus").focus(function(){
							newTagOnfocus();
						});
						jQuery("#newTag").unbind("keyup").keyup(function(){
							checkLength(this);
						});
						// 标签选中/取消功能绑定
						jQuery(".J_ChooseTagOne").unbind("click").click(function(){
							_this.chooseTag.call(_this, this);
						});
						// 添加标签按钮事件绑定
						jQuery("#J_SaveTagOneBtn").unbind("click").click(function(){
							_this.saveNewTag.call(_this);
						});
					});
				},
				// 显示活动关注成功提示浮层
				ShowFollowTopicSuc: function() {
					var title = "提示", node = jQuery("#dialogDiv");
					node.html('<a id="dialogA" href="#"></a>');
					$.jdThickBox({
						width: 300,
						height: 80,
						title: title,
						_box: "btn_coll_shop_pop",
						source: Follow.followVM.find("#followTopicSuccessDiv").html()
					});
				},
				// 关注店铺失败
				followShopFail: function() {
					var node = jQuery("#dialogDiv");
					node.html('<a id="dialogA" href="#"></a>');
					if (this.get("type") == "shopId") {
						Follow.followVM.find("#followFailSeeFollowUrl").attr("href", "http://t.jd.com/vender/followVenderList.action");
					} else {
						Follow.followVM.find("#followFailSeeFollowUrl").attr("href", "http://t.jd.com/activity/followActivityList.action");
					}
					$.jdThickBox({
						width: 300,
						height: 80,
						title: "提示",
						source: Follow.followVM.find("#followFailDiv").html()
					});
					return;
				},
				// 关注上限提示
				followShopMax: function() {
					var node = jQuery("#dialogDiv");
					node.html('<a id="dialogA" href="#"></a>');
					if (this.get("type") == "shopId") {
						Follow.followVM.find("#followMaxSeeFollowUrl").attr("href", "http://t.jd.com/vender/followVenderList.action");
					} else {
						Follow.followVM.find("#followMaxSeeFollowUrl").attr("href", "http://t.jd.com/activity/followActivityList.action");
					}
					$.jdThickBox({
						width: 300,
						height: 80,
						title: "提示",
						source: Follow.followVM.find("#followMaxDiv").html()
					});
					return;
				},
				// 重复关注同一店铺提示
				followed: function() {
					var _this = this, tip = "", url, type = this.get("type");
					if (type == "shopId") {
						tip = "已关注过该店铺";
						url = "http://follow.soa.jd.com/vender/queryForCount";
						Follow.followVM.find("#followedSeeFollowUrl").attr("href", "http://t.jd.com/vender/followVenderList.action");
					} else {
						tip = "已关注过该活动";
						url = "http://follow.soa.jd.com/activity/queryForCount";
						Follow.followVM.find("#followedSeeFollowUrl").attr("href", "http://t.jd.com/activity/followActivityList.action");
					}
					Follow.followVM.find("#followedTitle").html(tip);
					this.getFollowNum(url, function(data) {
						if (data.code == "F10000") {
							var outStr;
							if (type == "shopId") {
								outStr = "您已关注" + data.data + "个店铺";
							} else {
								outStr = "您已关注" + data.data + "个活动";
							}
							Follow.followVM.find("#followedNum").html(outStr);
						}
						var dialog = jQuery("#dialogDiv");
						dialog.html('<a id="dialogA" href="#"></a>');
						$.jdThickBox({
							width: 300,
							height: 80,
							title: "提示",
							source: Follow.followVM.find("#followedDiv").html()
						});
					});
				},
				// 标签提交保存操作
				doSubmit: function() {
					var _this = this, str = "", counter = 0;
					jQuery("#oldTags").find("a").each(function(index, item) {
						if ("true" == jQuery(this).attr("isCheck")) {
							counter++;
							if (str == "") {
								str = jQuery(this).html();
							} else {
								str = str + "," + jQuery(this).html();
							}
						}
					});
					jQuery("#newTags").find("a").each(function(index, item) {
						if ("true" == jQuery(this).attr("isCheck")) {
							counter++;
							if (str == "") {
								str = jQuery(this).html();
							} else {
								str = str + "," + jQuery(this).html();
							}
						}
					});
					if (str == "") {
						_this.showErrorMsg("请至少提供1个标签");
						return;
					}
					if (counter > 3) {
						_this.showErrorMsg("最多可选择3个标签");
						return;
					}
					str = encodeURIComponent(str);
					var url = "http://follow.soa.jd.com/vender/editTag";
					jQuery.ajax({
						async: false,
						url: url,
						dataType: "jsonp",
						data: {
							venderId: _this.get("id"),
							tagNames: str
						},
						success: function(data) {
							if (data.code == "F10000") {
								jQuery("#follow_error_msg").removeClass();
								jQuery("#follow_error_msg").addClass("hl_green fl");
								jQuery("#follow_error_msg").html("设置成功");
								jQuery("#follow_error_msg").show();
								setTimeout(function() {
									jdThickBoxclose();
								}, 5000);
							} else {
								if (data.code == "F0410") {
									_this.showErrorMsg("设置的标签数超过最大限制");
								} else {
									_this.showErrorMsg("设置失败");
								}
							}
						},
						error: function(data, xhr) {
							_this.showErrorMsg("设置失败");
						}
					});
				},
				showErrorMsg: function(err) {
					jQuery("#follow_error_msg").removeClass();
					jQuery("#follow_error_msg").addClass("att-tips fl");
					jQuery("#follow_error_msg").html(err);
					jQuery("#follow_error_msg").show();
					setTimeout(function() {
						jQuery("#follow_error_msg").hide();
					}, 3000);
				},
				saveNewTag: function() {
					var _this = this, val = jQuery("#newTag").val();
					val = val.trim();
					if (val.trim().length > 10) {
						this.showErrorMsg("长度不能超过10个字符");
						return;
					}
					var valid = this.validateNewTag(val);
					if (!valid) {
						this.showErrorMsg("标签数字、字母、汉字组成");
						return;
					}
					if (val == "" || val == jQuery("#newTag").attr("placeholder")) {
						this.showErrorMsg("请输入自定义名称！");
						jQuery("#newTag").val(jQuery("#newTag").attr("placeholder"));
						return;
					}
					jQuery("<li isNewAdd='true' ><a class='current' href='javascript:void(0)' isCheck='true' >" + val + "</a></li>").insertBefore(jQuery("#att-tag-new"));
					var content = jQuery("li[isNewAdd]"), tags = jQuery("li[isNewAdd] > .current");
					if (content.length >= 3) {
						jQuery("#att-tag-new").attr("style", "display:none");
					}
					tags.unbind("click").click(function(){
						_this.chooseTag(this);
					});
					jQuery("#newTag").val(jQuery("#newTag").attr("placeholder"));
				},
				chooseTag: function(tag) {
					var tNode = jQuery(tag), flag = tNode.attr("isCheck");
					if ("undefined" == typeof flag || flag == "false") {
						tNode.attr("isCheck", "true");
						tNode.addClass("current");
					} else {
						tNode.attr("isCheck", "false");
						tNode.removeClass("current");
					}
				},
				validateNewTag: function(tag) {
					var rTag = /[\u4e00-\u9fa5]|[0-9]|[a-z]|[A-Z]/g;
					var rArr = tag.match(rTag);
					var len = 0;
					if (rArr != null) {
						len = rArr.length;
					}
					if (len != tag.length) {
						return false;
					}
					return true;
				},
				getFollowedCount: function(id) {
					jQuery.ajax({
						async: false,
						url: "http://follow.soa.jd.com/vender/queryForCountByVid",
						dataType: "jsonp",
						data: {
							venderId: id
						},
						success: function(data) {
							var count = data.data;
							if (count > 500) {
								if (count > 10000) {
									count = parseInt(count / 10000);
									count = count + "万";
								}
								jQuery("#followedCount").html(count);
							}
						},
						error: function(data, shr) {}
					});
				}
			};
			
			return function(arg){
				var cfg = $.extend({},_default,arg);
				new Follow(cfg,$(this));
			}
		})(),
		/*
		 * @function：显示节点：触发一个元素，根据设定的数量按先后顺序显示元素
		 * @description：可应用于任意模块，只要有使用场景。
		 * @param：如{par : '.jSaleAttention20150423-1', node : 'li', btn : '.jBtn', pageNum : 10, className : 'current'}
		 * par为被显示元素的父级元素；node被显示元素；btn触发元素；pageNum每一次显示数量；className被显示元素增加的class名
		 * @author：20150427 by bjwanchuan
		 */
	   showNode : function(args){
		var _this = this,
			param = jQuery.extend({
			par : '.jSaleAttention20150423-1',
			node : 'li',
			btn : '.jBtn',
			pageNum : 10,
			className : 'current'
		 }, args || {}),
			par = jQuery(param.par),
			node = jQuery(_this).find(param.node),
			btn = jQuery(_this).find(param.btn),
			index = 0,
			pageTotal = Math.ceil(node.length/param.pageNum);

		function showData(){
			node.removeClass(param.className);
			for(var i = index*param.pageNum; i <= index*param.pageNum +param.pageNum - 1; i+=1){
				node.eq(i).addClass(param.className);
			}
		}
		showData();

		btn.click(function(){
			if((index+1) == pageTotal) {
				index = 0;
			}else{
				index +=1;
			}
			showData();
		});
		},
		/*
		 * @function：移入动画
		 * @description：对节点的移入及移出执行不同的CSS属性动画
		 * css value: backgroundPosition, borderWidth, borderBottomWidth, borderLeftWidth, borderRightWidth, borderTopWidth, borderSpacing, margin, marginBottom, marginLeft, marginRight, marginTop, outlineWidth, padding, paddingBottom, paddingLeft, paddingRight, paddingTop, height, width, maxHeight, maxWidth, minHeight, maxWidth, font, fontSize, bottom, left, right, top, letterSpacing, wordSpacing, lineHeight, textIndent, opacity
		 * 应用场景：所有
		 * @param：hoverNode执行css动画的节点；cssValueOne和cssValueTwo数组对象；timerOne和timerTwo为时间值
		 * @author：cdwanchuan@jd.com 2014-07-14
		*/
		hoverAnimate : function(args){
			var param = $.extend({
					node : 'li .jItem',
					cssValueOne : [
						{width: 235, height: 365, marginTop: -10, opacity:1},
						{width: 235, height: 355, marginTop: -5, opacity:0.9},
						{width: 235, height: 365, marginTop: -10, opacity:1}
					],
					cssValueTwo : [
						{width: 235, height: 345, marginTop: 0, opacity:1}
					],
					timerOne : 100,
					timerTwo : 100
				} , args||{}),
				_this = $(this),
				dom_node = _this.find(param.node),
				a_css_value_enter = param.cssValueOne,
				a_css_value_leave = param.cssValueTwo;
			
			dom_node.bind({
				mouseenter: function(){
					var count = a_css_value_enter.length,
						index = 0,
						target = $(this);
						
					function animate(){
						var caller = arguments.callee;
						target.animate(a_css_value_enter[index] , param.timerOne, function(){
							index++;
							if(index == count) return;
							caller();
						});
					}
					animate();
				},
				mouseleave: function(){
					var count = a_css_value_leave.length,
						index = 0,
						target = $(this);
					
					target.stop(true);
					
					function animate(){
						var caller = arguments.callee;
						target.animate(a_css_value_leave[index], param.timerTwo, function(){
							index++;
							if(index == count) return;
							caller();
						});
					}
					animate();
				}
			});
		},
		/*
		 * @function：获取促销标签
		 * @description：根据获取的促销标签编号显示促销标签
		 * 应用场景：带有SKUID商品的模块
		 * @param：node方法应用节点；tagNode标签节点；tagValue标签键值；dataNum每次最多能获取的商品数量；url接口；urlNum可用接口长度
		 * @author：cdwanchuan@jd.com 2014-07-15
		*/
		getProTag : function(arg){
			var param = $.extend({
					node : 'li',
					tagNode : '.jSlogan',
					tagValue : {1:'直降', 3:'返券', 4:'赠京豆', 5:'赠品', 11:'会员特价', 22:'京豆优惠购'} ,//标签键值
					dataNum : 40,//每次最多能获取的商品数量
					url : 'http://ad.3.cn/flags/mgets?callback=getPromotionTag&skuids=J_981821,J_1057746',//接口
					urlNum : 26//可用接口长度
				},arg),
				that = $(this),
				dom_node = that.find(param.node);

			if(!dom_node.length) return;

			function getTag(){
				var a_skuid = [];
				dom_node.each(function(index,n){
					a_skuid.push('J_' + $(n).attr('skuid'));
				});

				var len = Math.ceil(a_skuid.length/param.dataNum);

				for(var i=0; i<len; i++){
					var a_single_skuid =  a_skuid.slice(i*param.dataNum , Math.min(a_skuid.length , (i+1)*param.dataNum));

					$.ajax({
						url : param.url.substr(0,param.urlNum),
						data : {
							skuids : a_single_skuid.join(',')
						},
						dataType : 'jsonp',
						success : function(data){
							$.each(data,function(index,n){
								var dom = '';
								for(var i = 0; i<n.pf.length; i++){
									if(param.tagValue[n.pf[i]]){
										dom += '<span>' + param.tagValue[n.pf[i]] + '</span>';
									}
								}
								that.find(param.node + '[skuid=' + n.pid + ']').find(param.tagNode).html(dom);
							});
						}
					});
				}
			}
			getTag();
		},
		/*
		 * @function：向左移动
		 * @description：可应用于图片类模块。
		 * @param：如{}
		 * @author：20141021 cdwanchuan@jd.com
		 */
		marqueeLeft : function(args){
			var param = $.extend({
					node : '.scroll-area',
					tr : 'tr',
					td : 'td',
					speed : 20
				},args || {}),
				that = $(this),
				par = that.find(param.node)[0],
				tr = $(par).find("tr")[0],
				chi =$(par).find("td")[0];
				
			if(chi.offsetWidth>=par.offsetWidth){
				copyChild();
				var mar = setInterval(marquee, param.speed);
				par.onmouseover = function(){clearInterval(mar)};
				par.onmouseout = function(){mar = setInterval(marquee,param.speed)};
			}
			function copyChild(){
				var copy=document.createElement("td");
				copy.innerHTML=chi.innerHTML;
				tr.appendChild(copy);
			}
			
			function marquee(){
				if(chi.offsetWidth-par.scrollLeft<=0){
					par.scrollLeft-=chi.offsetWidth;
				}else{
					par.scrollLeft++;
				}
			}
		},
		/*
		 * @function：创建二维码
		 * @description：可应用于所有模块。
		 * @param：
		 * @author：20150605 cdwanchuan@jd.com
		 */
		createQrCode : function(args){
			var param = jQuery.extend({
				node : 'li',
				iconQrCode : '.iconQrCode',
				qrCodeArea : '.jQrCode',
				dataHref : 'qrHref',
				qrCode : '.qrPic',
				qrcJsImport : 'http://static.360buyimg.com/jshop/common/widget/qrCode/qrcode.min.js',
				current : 'current'
			}, args || {}),
				_this = jQuery(this),
				node = _this.find(param.node),
				iconQrCode = _this.find(param.iconQrCode),
				qrcJsImport = param.qrcJsImport,
				eventType = param.eventType,
				close = _this.find(param.close),
				current = param.current;
			
			//判断页面是否引入了二维码JS文件
			isQrcJsImport = typeof isQrcJsImport === "undefined"? false: isQrcJsImport;
			if (isQrcJsImport === false) {
				isQrcJsImport = true;
				jQuery.getScript(qrcJsImport, function (){});
			}
			
			//鼠标移动到节点上显示二维码
			iconQrCode.hover(function () {
				var dom = jQuery(this).closest(param.node);
				domOperate(dom);
			},function () {
				//var dom = jQuery(this).closest(param.node);
				//dom.removeClass(current);
			});
			
			//二维码主逻辑
			function domOperate(dom){
				var qrCodeArea = dom.find(param.qrCodeArea),
					qrCode = qrCodeArea.find(param.qrCode);
				
				if(qrCode.html() === '') {
					new QRCode(qrCode[0], {
						text:qrCodeArea.attr(param.dataHref).replace(/ /g, ""),
						width:qrCode.width(),
						height:qrCode.height()
					});
					qrCodeArea.removeAttr(param.dataHref);
				}
				dom.addClass(current);
				
				qrCodeArea.mouseleave(function(){
					dom.removeClass(current);
				});
			}
		},
		/*
		 * @function: 简单模板渲染
		 * @description：根据html模板及数据拼接html片段
		 * 应用场景：任意
		 * @param：
		 * @author：cdzhengwujiang@jd.com 2015-01-07
		 */
		renderHTML : function(tpl, data) {
			var subTpl = tpl,
				reg = /{([\w-_]+)}/,
				mArr;
			while (mArr = subTpl.match(reg)) {
				subTpl = subTpl.replace(reg, data[mArr[1]]);
			}
			return subTpl;
		},
		/*
		 * @function：页面跳转
		 * @description：
		 * 应用场景：装修、预览、浏览
		 * @param：value页面地址中的关键字；url需要跳转的地址；
		 * @author：cdwanchuan@jd.com 2015-06-30
		*/
		changePageUrl : function(args){
			var param = jQuery.extend({
				value : 'sale',
				url : 'http://www.jd.com'
			}, args || {});
			if(location.href.indexOf(param.value)!=-1){
				location.href = param.url;
			}
		}
	});
	
	
	function _execute(module){
		var _function = $(module).attr('module-function'),
			_module_name = $(module).parents('[module-name]').attr('module-name'), _param;
		if(typeof _function == 'undefined') return;
		try{
			_param = eval('(' + $(module).attr('module-param') + ')');
		}catch(e){
			_param = {};
		}
		var _functions = _function.split(',');
		_functions.each(function(index,n){
			if(jshop.module[_module_name]&&jshop.module[_module_name][n]){
				if(_param.subObj){
					$(module).find(_param.subObj).each(function(ind,q){
						jshop.module[_module_name][n].call(q,_param);
					});
				}
				else{
					jshop.module[_module_name][n].call(module,_param);
				}
			}
			else if(jshop.module[n]){
				if(_param.subObj){
					$(module).find(_param.subObj).each(function(ind,q){
						jshop.module[n].call(q,_param);
					});
				}
				else{
					jshop.module[n].call(module,_param);
				}
			}
		});
	}
	$(function(){			
		$('div.j-module').each(function(index,n){
			if(!$(n).attr('panda')){
				_execute(n);
			}
		});
	});
	
	/*
	 * 局部刷新逻辑
	 */
	w.moduleRefresh = function(){
		var _this = $(this);
		_this.each(function(index,n){
			_execute(n);
		});
	};
})(jQuery,window);

/***********************************************module lazyload***************************/
(function($,w){
	w.gModules = [];
	
	if(!Array.prototype.aUnique){
		Array.prototype.aUnique = function(arr){
			if(arr.constructor != Array)
				throw new Error('Array:aUnique, arguments error');
			var _temA = [];
			if(this.length == 0 ||(!arr.length))
				return arr;
			else{
				for(var i = 0, len = arr.length;i < len; i++){
					if(!this.isIn(arr[i])){
						_temA.push(arr[i]);
					}
				}
				return _temA;
			}
		};
	}
	
	/*
	 * 获取已经加载的模块
	 */
	function _get_modules(){
		if($('script[moduleinit="module"]').length){
			var _src = $('script[moduleinit="module"]').attr('src'),
				_js = _src.substring(_src.indexOf('?')+4,_src.indexOf('&'));
			w.gModules = _js.split(',');
		}
	}
	
	/*
	 * 新模块获取没有加载的js文件
	 */
	w.get_scripts = function(str){
		if(str == '' || str == undefined){
			return [];
		}
		var _module_scrips = str.split(',');
		return w.gModules.aUnique(_module_scrips);	
	};
	$(function(){
		_get_modules();
	});
})(jQuery,window);